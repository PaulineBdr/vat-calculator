<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAT Calculator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;
        const { Upload, Download, FileText } = lucide;

        function VATCalculator() {
          const [data, setData] = useState([]);
          const [fileName, setFileName] = useState('');
          const [error, setError] = useState('');
          const [vatRateAppointment, setVatRateAppointment] = useState(20);
          const [vatRateProduct, setVatRateProduct] = useState(10);
          const [vatRateGiftVoucher, setVatRateGiftVoucher] = useState(0);
          
          // Keywords for detection
          const [packageKeywords, setPackageKeywords] = useState('s√©ances,s√©ance,forfait,package,abonnement,subscription,sessions,session');
          const [giftVoucherKeywords, setGiftVoucherKeywords] = useState('bon cadeau,ch√®que cadeau,carte cadeau,gift card,gift voucher,voucher,gift certificate,massage,soin,spa,coupe,cut,coloration,color,balayage,m√®ches,highlights,brushing,manucure,manicure,p√©dicure,pedicure,facial,√©pilation,waxing,maquillage,makeup,soins du visage,skincare');
          const [showKeywords, setShowKeywords] = useState(false);

          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            setFileName(file.name);
            setError('');

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const parsedData = [];
                const paymentGroups = {};
                
                // First pass: group lines by payment ID
                for (let i = 1; i < lines.length; i++) {
                  if (!lines[i].trim()) continue;
                  
                  const values = [];
                  let current = '';
                  let inQuotes = false;
                  
                  for (let char of lines[i]) {
                    if (char === '"') {
                      inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                      values.push(current.trim());
                      current = '';
                    } else {
                      current += char;
                    }
                  }
                  values.push(current.trim());
                  
                  const row = {};
                  headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                  });
                  
                  const paymentId = row.payment;
                  if (!paymentGroups[paymentId]) {
                    paymentGroups[paymentId] = [];
                  }
                  paymentGroups[paymentId].push(row);
                }
                
                // Second pass: calculate VAT based on payment status
                const packageKw = packageKeywords.toLowerCase().split(',').map(k => k.trim());
                const giftKw = giftVoucherKeywords.toLowerCase().split(',').map(k => k.trim());
                
                for (const paymentId in paymentGroups) {
                  const group = paymentGroups[paymentId];
                  
                  // Check if there's a payment line (negative gross_value or payment transaction)
                  const hasPayment = group.some(row => {
                    const transaction = row.transaction?.toLowerCase() || '';
                    const grossValue = parseFloat(row.gross_value) || 0;
                    return grossValue < 0 || 
                           transaction.includes('carte') || 
                           transaction.includes('esp√®ces') ||
                           transaction.includes('especes') ||
                           transaction.includes('virement') ||
                           transaction.includes('cash') ||
                           transaction.includes('card');
                  });
                  
                  // Process each row in the group
                  group.forEach(row => {
                    const transaction = row.transaction?.toLowerCase() || '';
                    const type = row.type?.toLowerCase() || '';
                    const grossValue = parseFloat(row.gross_value) || 0;
                    
                    // Only calculate VAT if there's a payment AND it's appointment or product_sale
                    if (hasPayment && grossValue > 0) {
                      if (transaction === 'appointment') {
                        row.vat_amount = (grossValue * (vatRateAppointment / 100)).toFixed(2);
                        row.vat_rate = vatRateAppointment;
                        row.vat_category = 'Appointment';
                      } else if (transaction === 'product_sale') {
                        // Check for package keywords
                        const isPackage = packageKw.some(keyword => type.includes(keyword));
                        
                        if (isPackage) {
                          // Package = treat as appointment
                          row.vat_amount = (grossValue * (vatRateAppointment / 100)).toFixed(2);
                          row.vat_rate = vatRateAppointment;
                          row.vat_category = 'Package';
                        } else {
                          // Check for gift voucher keywords
                          const isGiftVoucher = giftKw.some(keyword => type.includes(keyword));
                          
                          if (isGiftVoucher) {
                            // Gift voucher = 0% VAT
                            row.vat_amount = (grossValue * (vatRateGiftVoucher / 100)).toFixed(2);
                            row.vat_rate = vatRateGiftVoucher;
                            row.vat_category = 'Gift Voucher';
                          } else {
                            // Physical product
                            row.vat_amount = (grossValue * (vatRateProduct / 100)).toFixed(2);
                            row.vat_rate = vatRateProduct;
                            row.vat_category = 'Product';
                          }
                        }
                      } else {
                        row.vat_amount = '';
                        row.vat_rate = '';
                        row.vat_category = '';
                      }
                    } else {
                      row.vat_amount = '';
                      row.vat_rate = '';
                      row.vat_category = '';
                    }
                    
                    parsedData.push(row);
                  });
                }
                
                setData(parsedData);
              } catch (err) {
                setError('Error reading file: ' + err.message);
              }
            };
            
            reader.readAsText(file);
          };

          const downloadCSV = () => {
            if (data.length === 0) return;
            
            const headers = ['payment', 'Heure et jour', 'transaction', 'type', 'gross_value', 
                             'VAT Rate', 'VAT Amount', 'VAT Category', 'shop', 'employee', 'customer_name', 'additional_info',
                             'bank_account', 'online_payment_arrival', 'online_payment_fee', 'url'];
            
            let csv = headers.join(',') + '\n';
            
            data.forEach(row => {
              const escapeCSV = (str) => {
                if (!str) return '';
                const stringValue = String(str);
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                  return `"${stringValue.replace(/"/g, '""')}"`;
                }
                return stringValue;
              };
              
              const values = [
                escapeCSV(row.payment),
                escapeCSV(row['Heure et jour']),
                escapeCSV(row.transaction),
                escapeCSV(row.type),
                escapeCSV(row.gross_value),
                escapeCSV(row.vat_rate ? row.vat_rate + '%' : ''),
                escapeCSV(row.vat_amount),
                escapeCSV(row.vat_category),
                escapeCSV(row.shop),
                escapeCSV(row.employee),
                escapeCSV(row.customer_name),
                escapeCSV(row.additional_info),
                escapeCSV(row.bank_account),
                escapeCSV(row.online_payment_arrival),
                escapeCSV(row.online_payment_fee),
                escapeCSV(row.url)
              ];
              csv += values.join(',') + '\n';
            });
            
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const newFileName = fileName.replace('.csv', '') + '_with_VAT.csv';
            link.download = newFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          };

          const formatCurrency = (value) => {
            if (!value) return '-';
            const num = parseFloat(value);
            return num.toFixed(2) + ' ‚Ç¨';
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
              <div className="max-w-7xl mx-auto">
                <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                  <div className="flex items-center gap-3 mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-600"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                    <h1 className="text-3xl font-bold text-gray-800">
                      VAT Calculator
                    </h1>
                  </div>
                  
                  <p className="text-gray-600 mb-6">
                    Import your payment CSV file to automatically calculate VAT with different rates based on transaction type.
                    <strong> VAT is only calculated for transactions that have been paid.</strong>
                  </p>

                  <div className="mb-6 bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-lg font-semibold text-indigo-900">VAT Rates Configuration</h3>
                      <button
                        onClick={() => setShowKeywords(!showKeywords)}
                        className="text-sm text-indigo-600 hover:text-indigo-800 underline"
                      >
                        {showKeywords ? 'Hide' : 'Show'} Keywords Settings
                      </button>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="bg-white rounded-lg p-4 border border-indigo-200">
                        <label className="block text-sm font-semibold text-green-800 mb-3">
                          üìÖ Appointments & Packages
                        </label>
                        <div className="flex gap-2 mb-3">
                          <button onClick={() => setVatRateAppointment(5.5)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateAppointment === 5.5 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>5.5%</button>
                          <button onClick={() => setVatRateAppointment(10)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateAppointment === 10 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>10%</button>
                          <button onClick={() => setVatRateAppointment(20)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateAppointment === 20 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>20%</button>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-sm text-gray-700">Custom:</span>
                          <input type="number" min="0" max="100" step="0.1" value={vatRateAppointment} onChange={(e) => setVatRateAppointment(parseFloat(e.target.value) || 0)} className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500"/>
                          <span className="text-sm text-gray-700">%</span>
                        </div>
                      </div>

                      <div className="bg-white rounded-lg p-4 border border-indigo-200">
                        <label className="block text-sm font-semibold text-blue-800 mb-3">
                          üõçÔ∏è Physical Products
                        </label>
                        <div className="flex gap-2 mb-3">
                          <button onClick={() => setVatRateProduct(5.5)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateProduct === 5.5 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>5.5%</button>
                          <button onClick={() => setVatRateProduct(10)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateProduct === 10 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>10%</button>
                          <button onClick={() => setVatRateProduct(20)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateProduct === 20 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>20%</button>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-sm text-gray-700">Custom:</span>
                          <input type="number" min="0" max="100" step="0.1" value={vatRateProduct} onChange={(e) => setVatRateProduct(parseFloat(e.target.value) || 0)} className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                          <span className="text-sm text-gray-700">%</span>
                        </div>
                      </div>

                      <div className="bg-white rounded-lg p-4 border border-indigo-200">
                        <label className="block text-sm font-semibold text-purple-800 mb-3">
                          üéÅ Gift Vouchers
                        </label>
                        <div className="bg-yellow-50 border border-yellow-200 rounded p-2 mb-3">
                          <p className="text-xs text-yellow-800">
                            <strong>‚ö†Ô∏è Important:</strong> Check with the client when VAT should be declared:
                            <br/>‚Ä¢ <strong>At voucher purchase</strong> ‚Üí Set appropriate rate
                            <br/>‚Ä¢ <strong>At voucher use</strong> ‚Üí Keep at 0% (VAT will be declared when used)
                          </p>
                        </div>
                        <div className="flex gap-2 mb-3">
                          <button onClick={() => setVatRateGiftVoucher(0)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateGiftVoucher === 0 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>0%</button>
                          <button onClick={() => setVatRateGiftVoucher(5.5)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateGiftVoucher === 5.5 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>5.5%</button>
                          <button onClick={() => setVatRateGiftVoucher(10)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateGiftVoucher === 10 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>10%</button>
                          <button onClick={() => setVatRateGiftVoucher(20)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateGiftVoucher === 20 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>20%</button>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-sm text-gray-700">Custom:</span>
                          <input type="number" min="0" max="100" step="0.1" value={vatRateGiftVoucher} onChange={(e) => setVatRateGiftVoucher(parseFloat(e.target.value) || 0)} className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                          <span className="text-sm text-gray-700">%</span>
                        </div>
                      </div>
                    </div>

                    {showKeywords && (
                      <div className="mt-4 pt-4 border-t border-indigo-200">
                        <h4 className="text-sm font-semibold text-indigo-900 mb-3">Keywords Detection Settings</h4>
                        <div className="space-y-3">
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Package Keywords (comma-separated)
                            </label>
                            <input
                              type="text"
                              value={packageKeywords}
                              onChange={(e) => setPackageKeywords(e.target.value)}
                              className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                              placeholder="s√©ances,s√©ance,forfait,package"
                            />
                            <p className="text-xs text-gray-500 mt-1">
                              Product sales containing these keywords will be treated as packages
                            </p>
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">
                              Gift Voucher Keywords (comma-separated)
                            </label>
                            <input
                              type="text"
                              value={giftVoucherKeywords}
                              onChange={(e) => setGiftVoucherKeywords(e.target.value)}
                              className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                              placeholder="bon cadeau,gift,voucher,massage,soin"
                            />
                            <p className="text-xs text-gray-500 mt-1">
                              Product sales containing these keywords will be treated as gift vouchers (0% VAT)
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  <div className="flex gap-4 mb-6">
                    <label className="flex-1 cursor-pointer">
                      <div className="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                        <span>Load CSV File</span>
                      </div>
                      <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden"/>
                    </label>

                    {data.length > 0 && (
                      <button onClick={downloadCSV} className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        <span>Download with VAT</span>
                      </button>
                    )}
                  </div>

                  {fileName && (
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                      <p className="text-blue-800">
                        <strong>File loaded:</strong> {fileName}
                        {data.length > 0 && ` (${data.length} rows)`}
                      </p>
                    </div>
                  )}

                  {error && (
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                      <p className="text-red-800">{error}</p>
                    </div>
                  )}
                </div>

                {data.length > 0 && (
                  <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-indigo-600 text-white">
                          <tr>
                            <th className="px-4 py-3 text-left text-sm font-semibold">ID</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Date & Time</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Transaction</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Type</th>
                            <th className="px-4 py-3 text-right text-sm font-semibold">Gross Value</th>
                            <th className="px-4 py-3 text-center text-sm font-semibold">Category</th>
                            <th className="px-4 py-3 text-center text-sm font-semibold">VAT Rate</th>
                            <th className="px-4 py-3 text-right text-sm font-semibold">VAT Amount</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Employee</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Customer</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Add. Info</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Bank Acc.</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Payment Arr.</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Payment Fee</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">URL</th>
                          </tr>
                        </thead>
                        <tbody>
                          {data.map((row, index) => (
                            <tr key={index} className={`border-b border-gray-200 ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-indigo-50 transition-colors`}>
                              <td className="px-4 py-3 text-sm">{row.payment}</td>
                              <td className="px-4 py-3 text-sm">{row['Heure et jour']}</td>
                              <td className="px-4 py-3 text-sm">
                                <span className={`px-2 py-1 rounded text-xs ${row.transaction === 'appointment' ? 'bg-green-100 text-green-800' : row.transaction === 'product_sale' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`}>
                                  {row.transaction}
                                </span>
                              </td>
                              <td className="px-4 py-3 text-sm">{row.type}</td>
                              <td className="px-4 py-3 text-sm text-right font-medium">{formatCurrency(row.gross_value)}</td>
                              <td className="px-4 py-3 text-sm text-center">
                                {row.vat_category && (
                                  <span className={`px-2 py-1 rounded text-xs font-semibold ${row.vat_category === 'Appointment' ? 'bg-green-100 text-green-800' : row.vat_category === 'Package' ? 'bg-green-100 text-green-800' : row.vat_category === 'Product' ? 'bg-blue-100 text-blue-800' : row.vat_category === 'Gift Voucher' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}`}>
                                    {row.vat_category}
                                  </span>
                                )}
                              </td>
                              <td className="px-4 py-3 text-sm text-center">
                                {row.vat_rate !== '' && (
                                  <span className="px-2 py-1 rounded text-xs font-semibold bg-indigo-100 text-indigo-800">
                                    {row.vat_rate}%
                                  </span>
                                )}
                              </td>
                              <td className="px-4 py-3 text-sm text-right font-bold text-indigo-600">{row.vat_amount ? formatCurrency(row.vat_amount) : '-'}</td>
                              <td className="px-4 py-3 text-sm">{row.employee}</td>
                              <td className="px-4 py-3 text-sm">{row.customer_name}</td>
                              <td className="px-4 py-3 text-sm text-gray-600">{row.additional_info}</td>
                              <td className="px-4 py-3 text-sm text-gray-600">{row.bank_account}</td>
                              <td className="px-4 py-3 text-sm text-gray-600">{row.online_payment_arrival}</td>
                              <td className="px-4 py-3 text-sm text-gray-600">{row.online_payment_fee}</td>
                              <td className="px-4 py-3 text-sm">
                                {row.url && (
                                  <a href={row.url} target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:text-indigo-800 underline text-xs">
                                    Link
                                  </a>
                                )}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        ReactDOM.render(<VATCalculator />, document.getElementById('root'));
    </script>
</body>
</html>
