<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAT Calculator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body { margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .print-section { box-shadow: none !important; }
            table { page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // Lucide Icons as SVG components
        const Upload = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
            </svg>
        );

        const FileText = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
            </svg>
        );

        const FileSpreadsheet = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="8" y1="13" x2="16" y2="13"/>
                <line x1="8" y1="17" x2="16" y2="17"/>
            </svg>
        );

        const FileType = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
            </svg>
        );

        function VATCalculator() {
            const [data, setData] = useState([]);
            const [fileName, setFileName] = useState('');
            const [error, setError] = useState('');
            const [vatRateAppointment, setVatRateAppointment] = useState(20);
            const [vatRateProduct, setVatRateProduct] = useState(20);
            const [vatRateGiftVoucher, setVatRateGiftVoucher] = useState(0);
            const [exportLanguage, setExportLanguage] = useState('en');
            
            const [enableSpecificProductRate, setEnableSpecificProductRate] = useState(false);
            const [vatRateProductSpecific, setVatRateProductSpecific] = useState(5.5);
            const [specificProductCategoryName, setSpecificProductCategoryName] = useState('Product (Specific)');
            const [specificProductKeywords, setSpecificProductKeywords] = useState('');
        
            const translateCategory = (category) => {
                if (exportLanguage === 'fr') {
                    const translations = {
                        'Appointment': 'Rendez-vous',
                        'Appointment (Paid by Gift Voucher)': 'Rendez-vous (Payé par Bon Cadeau)',
                        'Appointment (Partial Gift Voucher)': 'Rendez-vous (Bon Cadeau Partiel)',  // AJOUTER CETTE LIGNE
                        'Package': 'Forfait',
                        'Product': 'Produit',
                        'Gift Voucher': 'Bon Cadeau'
                    };
                    return translations[category] || category;
                }
                return category;
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setFileName(file.name);
                setError('');

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        const headers = lines[0].split(',').map(h => h.trim());
                        
                        const parsedData = [];
                        const paymentGroups = {};
                        
                        for (let i = 1; i < lines.length; i++) {
                            if (!lines[i].trim()) continue;
                            
                            const values = [];
                            let current = '';
                            let inQuotes = false;
                            
                            for (let char of lines[i]) {
                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    values.push(current.trim());
                                    current = '';
                                } else {
                                    current += char;
                                }
                            }
                            values.push(current.trim());
                            
                            const row = {};
                            headers.forEach((header, index) => {
                                const cleanHeader = header.trim().toLowerCase();
                                row[header] = values[index] || '';
                                
                                // Copier aussi dans 'Heure et jour' si c'est la colonne datetime
                                if (cleanHeader === 'datetime' || cleanHeader === 'date and time' || cleanHeader === 'date_and_time' || cleanHeader === 'heure et jour') {
                                    row['Heure et jour'] = values[index] || '';
                                }
                            });
                            
                            const paymentId = row.payment;
                            if (!paymentGroups[paymentId]) {
                                paymentGroups[paymentId] = [];
                            }
                            paymentGroups[paymentId].push(row);
                        }
                        
                        const specificProdKw = enableSpecificProductRate ? specificProductKeywords.toLowerCase().split(',').map(k => k.trim()).filter(k => k) : [];
                        
                        for (const paymentId in paymentGroups) {
                            const group = paymentGroups[paymentId];
                            
                            const hasPayment = group.some(row => {
                                const transaction = row.transaction?.toLowerCase() || '';
                                const grossValue = parseFloat(row.gross_value) || 0;
                                return grossValue < 0 || 
                                       transaction.includes('carte') || 
                                       transaction.includes('espèces') ||
                                       transaction.includes('especes') ||
                                       transaction.includes('virement') ||
                                       transaction.includes('cash') ||
                                       transaction.includes('card');
                            });
                            // Check whether a gift voucher has been used for this payment.
                            const hasGiftVoucherPayment = group.some(row => {
                                const transaction = row.transaction?.toLowerCase() || '';
                                return transaction === 'gift_voucher_applied' || transaction === 'gift_vouhcher_applied';
                            });
                            // Calculate totals for proportional gift voucher allocation
                            let totalAppointments = 0;
                            let giftVoucherAmount = 0;
                            
                            group.forEach(row => {
                                const transaction = row.transaction?.toLowerCase() || '';
                                const grossValue = parseFloat(row.gross_value) || 0;
                                
                                if (transaction === 'appointment' && grossValue > 0) {
                                    totalAppointments += grossValue;
                                }
                                if (transaction === 'gift_voucher_applied' || transaction === 'gift_vouhcher_applied') {
                                    giftVoucherAmount += Math.abs(grossValue);
                                }
                            });
                            group.forEach(row => {
                                const transaction = row.transaction?.toLowerCase() || '';
                                const type = row.type?.toLowerCase() || '';
                                const grossValue = parseFloat(row.gross_value) || 0;
                                
                                if (hasPayment && grossValue > 0) {
                                    if (transaction === 'appointment') {
                                        // Calculate proportional gift voucher allocation
                                        let amountToTax = grossValue;
                                        
                                        if (hasGiftVoucherPayment && vatRateGiftVoucher > 0 && totalAppointments > 0) {
                                            // Si TVA > 0% sur bon cadeau = TVA déjà payée à l'achat
                                            // Calculate proportion of this appointment
                                            const proportion = grossValue / totalAppointments;
                                            const giftVoucherPart = proportion * Math.abs(giftVoucherAmount);
                                            // Amount to tax = total - gift voucher part (VAT already paid on gift voucher)
                                            amountToTax = grossValue - giftVoucherPart;
                                            console.log('=== DEBUG ===');
                                            console.log('Service:', type);
                                            console.log('Total appointments:', totalAppointments);
                                            console.log('Gift voucher amount:', giftVoucherAmount);
                                            console.log('This service TTC:', grossValue);
                                            console.log('Proportion:', proportion);
                                            console.log('Gift voucher part:', giftVoucherPart);
                                            console.log('Amount to tax:', amountToTax);
                                            console.log('vatRateGiftVoucher:', vatRateGiftVoucher);
                                        }
                                        
                                       // Déterminer la catégorie et calculer la TVA
                                        if (hasGiftVoucherPayment) {
                                            if (vatRateGiftVoucher > 0) {
                                                // TVA appliquée à l'achat du bon cadeau
                                                // On ne taxe QUE la partie non payée par bon cadeau
                                                const calculatedVAT = (amountToTax * (vatRateAppointment / (100 + vatRateAppointment))).toFixed(2);
                                                
                                                if (amountToTax === 0) {
                                                    // 100% bon cadeau - Pas de TVA à déclarer au rdv
                                                    row.vat_rate = '';
                                                    row.vat_amount = '';
                                                    row.vat_category = 'Appointment (Paid by Gift Voucher)';
                                                } else if (amountToTax < grossValue) {
                                                    // Paiement mixte : afficher le montant taxé
                                                    row.type = row.type + ` [taxé:${amountToTax.toFixed(2)}€]`;
                                                    row.vat_rate = vatRateAppointment;
                                                    row.vat_amount = calculatedVAT;
                                                    row.vat_category = 'Appointment (Partial Gift Voucher)';
                                                } else {
                                                    // Pas de bon cadeau utilisé (ne devrait pas arriver)
                                                    row.vat_rate = vatRateAppointment;
                                                    row.vat_amount = calculatedVAT;
                                                    row.vat_category = 'Appointment';
                                                }
                                            } else {
                                                // TVA à 0% sur bon cadeau = TVA au moment du rdv
                                                // On taxe TOUT le montant du rendez-vous
                                                row.vat_rate = vatRateAppointment;
                                                row.vat_amount = (grossValue * (vatRateAppointment / (100 + vatRateAppointment))).toFixed(2);
                                                
                                                // Calculer la part bon cadeau pour le récapitulatif
                                                if (totalAppointments > 0) {
                                                    const proportion = grossValue / totalAppointments;
                                                    const giftVoucherPart = proportion * giftVoucherAmount;
                                                    row._giftVoucherPart = giftVoucherPart;
                                                    row._amountToTax = grossValue - giftVoucherPart;
                                                }
                                                
                                                // Vérifier si c'est 100% BC ou mixte
                                                const hasOtherPayment = group.some(r => {
                                                    const t = r.transaction?.toLowerCase() || '';
                                                    const gv = parseFloat(r.gross_value) || 0;
                                                    return gv < 0 && t !== 'gift_voucher_applied' && t !== 'gift_vouhcher_applied';
                                                });
                                                
                                                if (hasOtherPayment) {
                                                    row.vat_category = 'Appointment (Partial Gift Voucher)';
                                                } else {
                                                    row.vat_category = 'Appointment (Paid by Gift Voucher)';
                                                }
                                            }
                                        } else {
                                            // Pas de bon cadeau
                                            row.vat_rate = vatRateAppointment;
                                            row.vat_amount = (grossValue * (vatRateAppointment / (100 + vatRateAppointment))).toFixed(2);
                                            row.vat_category = 'Appointment';
                                        }
                                    } else if (transaction === 'product_sale' || transaction === 'package_sale' || transaction === 'gift_voucher_sale') {
                                        // Identifier le type de vente directement depuis transaction
                                        const isPackage = transaction === 'package_sale';
                                        const isGiftVoucher = transaction === 'gift_voucher_sale';
                                        const isProduct = transaction === 'product_sale';
                                        
                                        // Pour les gift vouchers : pas de calcul de proportion (ne peuvent pas être payés par gift voucher)
                                        if (isGiftVoucher) {
                                            row.vat_amount = (grossValue * (vatRateGiftVoucher / (100 + vatRateGiftVoucher))).toFixed(2);
                                            row.vat_rate = vatRateGiftVoucher;
                                            row.vat_category = 'Gift Voucher';
                                        } else {
                                            // Pour produits et forfaits : calcul de proportion si payé partiellement par gift voucher
                                            let amountToTax = grossValue;
                                            let totalProducts = 0;
                                            
                                            // Calculer le total des produits/forfaits dans ce paiement
                                            group.forEach(r => {
                                                const t = r.transaction?.toLowerCase() || '';
                                                const gv = parseFloat(r.gross_value) || 0;
                                                if ((t === 'product_sale' || t === 'package_sale') && gv > 0) {
                                                    totalProducts += gv;
                                                }
                                            });
                                            
                                            if (hasGiftVoucherPayment && vatRateGiftVoucher > 0 && totalProducts > 0) {
                                                // Si TVA > 0% sur bon cadeau = TVA déjà payée à l'achat
                                                const proportion = grossValue / totalProducts;
                                                const giftVoucherPart = proportion * Math.abs(giftVoucherAmount);
                                                amountToTax = grossValue - giftVoucherPart;
                                            }
                                            
                                            if (isPackage) {
                                                // ===== FORFAIT =====
                                                if (hasGiftVoucherPayment) {
                                                    if (vatRateGiftVoucher > 0) {
                                                        // TVA appliquée à l'achat du bon cadeau
                                                        const calculatedVAT = (amountToTax * (vatRateAppointment / (100 + vatRateAppointment))).toFixed(2);
                                                        
                                                        if (amountToTax === 0) {
                                                            row.vat_rate = '';
                                                            row.vat_amount = '';
                                                            row.vat_category = 'Package (Paid by Gift Voucher)';
                                                        } else if (amountToTax < grossValue) {
                                                            row.type = row.type + ` [taxé:${amountToTax.toFixed(2)}€]`;
                                                            row.vat_rate = vatRateAppointment;
                                                            row.vat_amount = calculatedVAT;
                                                            row.vat_category = 'Package (Partial Gift Voucher)';
                                                        } else {
                                                            row.vat_rate = vatRateAppointment;
                                                            row.vat_amount = calculatedVAT;
                                                            row.vat_category = 'Package';
                                                        }
                                                    } else {
                                                        // TVA à 0% sur bon cadeau = TVA au moment de l'utilisation
                                                        row.vat_rate = vatRateAppointment;
                                                        row.vat_amount = (grossValue * (vatRateAppointment / (100 + vatRateAppointment))).toFixed(2);
                                                        
                                                        // Calculer la part bon cadeau pour le récapitulatif
                                                        if (totalProducts > 0) {
                                                            const proportion = grossValue / totalProducts;
                                                            const giftVoucherPart = proportion * giftVoucherAmount;
                                                            row._giftVoucherPart = giftVoucherPart;
                                                            row._amountToTax = grossValue - giftVoucherPart;
                                                        }
                                                        
                                                        const hasOtherPayment = group.some(r => {
                                                            const t = r.transaction?.toLowerCase() || '';
                                                            const gv = parseFloat(r.gross_value) || 0;
                                                            return gv < 0 && t !== 'gift_voucher_applied' && t !== 'gift_vouhcher_applied';
                                                        });
                                                        row.vat_category = hasOtherPayment ? 'Package (Partial Gift Voucher)' : 'Package (Paid by Gift Voucher)';
                                                    }
                                                } else {
                                                    row.vat_rate = vatRateAppointment;
                                                    row.vat_amount = (grossValue * (vatRateAppointment / (100 + vatRateAppointment))).toFixed(2);
                                                    row.vat_category = 'Package';
                                                }
                                                
                                            } else if (isProduct) {
                                                // ===== PRODUIT =====
                                                const isSpecificProduct = enableSpecificProductRate && specificProdKw.some(keyword => type.includes(keyword));
                                                
                                                if (isSpecificProduct) {
                                                    // Produit avec taux spécifique
                                                    if (hasGiftVoucherPayment) {
                                                        if (vatRateGiftVoucher > 0) {
                                                            // TVA appliquée à l'achat du bon cadeau
                                                            const calculatedVAT = (amountToTax * (vatRateProductSpecific / (100 + vatRateProductSpecific))).toFixed(2);
                                                            
                                                            if (amountToTax === 0) {
                                                                row.vat_rate = '';
                                                                row.vat_amount = '';
                                                                row.vat_category = specificProductCategoryName + ' (Paid by Gift Voucher)';
                                                            } else if (amountToTax < grossValue) {
                                                                // Stocker les valeurs pour le récapitulatif
                                                                row._giftVoucherPart = grossValue - amountToTax;
                                                                row._amountToTax = amountToTax;
                                                                row.type = row.type + ` [taxé:${amountToTax.toFixed(2)}€]`;
                                                                row.vat_rate = vatRateProductSpecific;
                                                                row.vat_amount = calculatedVAT;
                                                                row.vat_category = specificProductCategoryName + ' (Partial Gift Voucher)';
                                                            } else {
                                                                row.vat_rate = vatRateProductSpecific;
                                                                row.vat_amount = calculatedVAT;
                                                                row.vat_category = specificProductCategoryName;
                                                            }
                                                        } else {
                                                            // TVA à 0% sur bon cadeau = TVA au moment de l'utilisation
                                                            row.vat_rate = vatRateProductSpecific;
                                                            row.vat_amount = (grossValue * (vatRateProductSpecific / (100 + vatRateProductSpecific))).toFixed(2);
                                                            
                                                            if (totalProducts > 0) {
                                                                const proportion = grossValue / totalProducts;
                                                                const giftVoucherPart = proportion * giftVoucherAmount;
                                                                row._giftVoucherPart = giftVoucherPart;
                                                                row._amountToTax = grossValue - giftVoucherPart;
                                                            }
                                                            
                                                            const hasOtherPayment = group.some(r => {
                                                                const t = r.transaction?.toLowerCase() || '';
                                                                const gv = parseFloat(r.gross_value) || 0;
                                                                return gv < 0 && t !== 'gift_voucher_applied' && t !== 'gift_vouhcher_applied';
                                                            });
                                                            row.vat_category = hasOtherPayment ? specificProductCategoryName + ' (Partial Gift Voucher)' : specificProductCategoryName + ' (Paid by Gift Voucher)';
                                                        }
                                                    } else {
                                                        row.vat_rate = vatRateProductSpecific;
                                                        row.vat_amount = (grossValue * (vatRateProductSpecific / (100 + vatRateProductSpecific))).toFixed(2);
                                                        row.vat_category = specificProductCategoryName;
                                                    }
                                                } else {
                                                    // Produit standard (pas de taux spécifique)
                                                    if (hasGiftVoucherPayment) {
                                                        if (vatRateGiftVoucher > 0) {
                                                            // TVA appliquée à l'achat du bon cadeau
                                                            const calculatedVAT = (amountToTax * (vatRateProduct / (100 + vatRateProduct))).toFixed(2);
                                                            
                                                            if (amountToTax === 0) {
                                                                row.vat_rate = '';
                                                                row.vat_amount = '';
                                                                row.vat_category = 'Product (Paid by Gift Voucher)';
                                                            } else if (amountToTax < grossValue) {
                                                                // Stocker les valeurs pour le récapitulatif
                                                                row._giftVoucherPart = grossValue - amountToTax;
                                                                row._amountToTax = amountToTax;
                                                                row.type = row.type + ` [taxé:${amountToTax.toFixed(2)}€]`;
                                                                row.vat_rate = vatRateProduct;
                                                                row.vat_amount = calculatedVAT;
                                                                row.vat_category = 'Product (Partial Gift Voucher)';
                                                            } else {
                                                                row.vat_rate = vatRateProduct;
                                                                row.vat_amount = calculatedVAT;
                                                                row.vat_category = 'Product';
                                                            }
                                                        } else {
                                                            // TVA à 0% sur bon cadeau = TVA au moment de l'utilisation
                                                            row.vat_rate = vatRateProduct;
                                                            row.vat_amount = (grossValue * (vatRateProduct / (100 + vatRateProduct))).toFixed(2);
                                                            
                                                            // Calculer la part bon cadeau pour le récapitulatif
                                                            if (totalProducts > 0) {
                                                                const proportion = grossValue / totalProducts;
                                                                const giftVoucherPart = proportion * giftVoucherAmount;
                                                                row._giftVoucherPart = giftVoucherPart;
                                                                row._amountToTax = grossValue - giftVoucherPart;
                                                            }
                                                            
                                                            // Vérifier si c'est 100% BC ou mixte
                                                            const hasOtherPayment = group.some(r => {
                                                                const t = r.transaction?.toLowerCase() || '';
                                                                const gv = parseFloat(r.gross_value) || 0;
                                                                return gv < 0 && t !== 'gift_voucher_applied' && t !== 'gift_vouhcher_applied';
                                                            });
                                                            
                                                            if (hasOtherPayment) {
                                                                row.vat_category = 'Product (Partial Gift Voucher)';
                                                            } else {
                                                                row.vat_category = 'Product (Paid by Gift Voucher)';
                                                            }
                                                        }
                                                    } else {
                                                        // Pas de paiement par bon cadeau
                                                        row.vat_rate = vatRateProduct;
                                                        row.vat_amount = (grossValue * (vatRateProduct / (100 + vatRateProduct))).toFixed(2);
                                                        row.vat_category = 'Product';
                                                    }
                                                }
                                            }
                                        }
                                    } else {
                                        row.vat_amount = '';
                                        row.vat_rate = '';
                                        row.vat_category = '';
                                    }
                                } else {
                                    row.vat_amount = '';
                                    row.vat_rate = '';
                                    row.vat_category = '';
                                }
                                
                                parsedData.push(row);
                            });
                        }
                        
                        setData(parsedData);
                    } catch (err) {
                        setError('Error reading file: ' + err.message);
                    }
                };
                
                reader.readAsText(file);
            };

            const downloadCSV = () => {
                if (data.length === 0) return;
                
                const headers = exportLanguage === 'fr' 
                    ? ['paiement', 'Heure et jour', 'transaction', 'type', 'valeur_brute', 
                       'Taux TVA', 'Montant TVA', 'Catégorie TVA', 'boutique', 'employé', 'nom_client', 'info_additionnelle',
                       'compte_bancaire', 'arrivée_paiement_en_ligne', 'frais_paiement_en_ligne', 'url']
                    : ['payment', 'Date and time', 'transaction', 'type', 'gross_value', 
                       'VAT Rate', 'VAT Amount', 'VAT Category', 'shop', 'employee', 'customer_name', 'additional_info',
                       'bank_account', 'online_payment_arrival', 'online_payment_fee', 'url'];
                
                let csv = headers.join(',') + '\n';
                
                data.forEach(row => {
                    const escapeCSV = (str) => {
                        if (!str) return '';
                        const stringValue = String(str);
                        if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                            return '"' + stringValue.replace(/"/g, '""') + '"';
                        }
                        return stringValue;
                    };
                    
                    const values = [
                        escapeCSV(row.payment),
                        escapeCSV(row['Heure et jour'] || row['datetime'] || row['Date and time'] || row['date_and_time']),
                        escapeCSV(row.transaction),
                        escapeCSV(row.type),
                        escapeCSV(row.gross_value),
                        escapeCSV(row.vat_rate ? row.vat_rate + '%' : ''),
                        escapeCSV(row.vat_amount),
                        escapeCSV(translateCategory(row.vat_category)),
                        escapeCSV(row.shop),
                        escapeCSV(row.employee),
                        escapeCSV(row.customer_name),
                        escapeCSV(row.additional_info),
                        escapeCSV(row.bank_account),
                        escapeCSV(row.online_payment_arrival),
                        escapeCSV(row.online_payment_fee),
                        escapeCSV(row.url)
                    ];
                    csv += values.join(',') + '\n';
                });
                
                const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                const suffix = exportLanguage === 'fr' ? '_avec_TVA' : '_with_VAT';
                const newFileName = fileName.replace('.csv', '') + suffix + '.csv';
                link.download = newFileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            const downloadExcel = () => {
                if (data.length === 0) return;
            
                const wb = XLSX.utils.book_new();
                
                // ========================================
                // ONGLET 1: Full Details
                // ========================================
                const detailsHeaders = exportLanguage === 'fr'
                    ? ['paiement', 'Heure et jour', 'transaction', 'type', 'valeur_brute', 
                       'Taux TVA', 'Montant TVA', 'Catégorie TVA', 'boutique', 'employé', 'nom_client', 
                       'info_additionnelle', 'compte_bancaire', 'arrivée_paiement_en_ligne', 'frais_paiement_en_ligne', 'url']
                    : ['payment', 'Date and time', 'transaction', 'type', 'gross_value', 
                       'VAT Rate', 'VAT Amount', 'VAT Category', 'shop', 'employee', 'customer_name', 
                       'additional_info', 'bank_account', 'online_payment_arrival', 'online_payment_fee', 'url'];
                
                const detailsData = data.map(row => [
                    row.payment,
                    row['Heure et jour'] || row['datetime'] || row['Date and time'] || row['date_and_time'],
                    row.transaction,
                    row.type,
                    parseFloat(row.gross_value) || 0,
                    row.vat_rate ? row.vat_rate + '%' : '',
                    parseFloat(row.vat_amount) || '',
                    translateCategory(row.vat_category) || '',
                    row.shop,
                    row.employee,
                    row.customer_name,
                    row.additional_info,
                    row.bank_account,
                    row.online_payment_arrival,
                    row.online_payment_fee,
                    row.url
                ]);
            
                const wsDetails = XLSX.utils.aoa_to_sheet([detailsHeaders, ...detailsData]);
                wsDetails['!cols'] = [
                    { wch: 10 }, { wch: 16 }, { wch: 14 }, { wch: 30 }, { wch: 12 },
                    { wch: 10 }, { wch: 12 }, { wch: 18 }, { wch: 12 }, { wch: 15 },
                    { wch: 20 }, { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 50 }
                ];
                XLSX.utils.book_append_sheet(wb, wsDetails, exportLanguage === 'fr' ? 'Détails Complets' : 'Full Details');
                
                // ========================================
                // ONGLET 2: Summary VAT
                // ========================================
                const vatSummaryHeaders = exportLanguage === 'fr'
                    ? ['Catégorie', 'HT', 'TVA', 'TTC']
                    : ['Category', 'Excl. VAT', 'VAT', 'Incl. VAT'];
                
                const vatSummaryData = [
                    vatSummaryHeaders,
                    [
                        translate('Total Period'),
                        summary.total.ht.toFixed(2) + ' €',
                        summary.total.tva.toFixed(2) + ' €',
                        summary.total.ttc.toFixed(2) + ' €'
                    ]
                ];
                
                // Ajouter "Total hors BC" seulement si des BC ont été utilisés
               if (summary.appointmentsGiftVoucher.ttc > 0) {
                    vatSummaryData.push([
                        translate('Total Period (Excl. Gift Voucher Payments)'),
                        (summary.total.ht - summary.appointmentsGiftVoucher.ht - summary.packagesGiftVoucher.ht - summary.productsGiftVoucher.ht - summary.specificProductsGiftVoucher.ht).toFixed(2) + ' €',
                        summary.total.tva.toFixed(2) + ' €',
                        (summary.total.ttc - summary.appointmentsGiftVoucher.ttc - summary.packagesGiftVoucher.ttc - summary.productsGiftVoucher.ttc - summary.specificProductsGiftVoucher.ttc).toFixed(2) + ' €'
                    ]);
                }
                
                vatSummaryData.push([]);
                
                if (summary.appointments.ttc > 0) {
                    if (summary.appointmentsGiftVoucher.ttc > 0) {
                        // Afficher le détail avec sous-catégories
                        vatSummaryData.push([
                            translate('Appointments (Total)'),
                            summary.appointments.ht.toFixed(2) + ' €',
                            summary.appointments.tva.toFixed(2) + ' €',
                            summary.appointments.ttc.toFixed(2) + ' €'
                        ]);
                        vatSummaryData.push([
                            '  ' + translate('Paid by Gift Voucher'),
                            summary.appointmentsGiftVoucher.ht.toFixed(2) + ' €',
                            summary.appointmentsGiftVoucher.tva.toFixed(2) + ' €',
                            summary.appointmentsGiftVoucher.ttc.toFixed(2) + ' €'
                        ]);
                        vatSummaryData.push([
                            '  ' + translate('Paid by Other Methods'),
                            summary.appointmentsOther.ht.toFixed(2) + ' €',
                            summary.appointmentsOther.tva.toFixed(2) + ' €',
                            summary.appointmentsOther.ttc.toFixed(2) + ' €'
                        ]);
                    } else {
                        // Afficher une seule ligne "Appointments"
                        vatSummaryData.push([
                            translate('Appointments'),
                            summary.appointments.ht.toFixed(2) + ' €',
                            summary.appointments.tva.toFixed(2) + ' €',
                            summary.appointments.ttc.toFixed(2) + ' €'
                        ]);
                    }
                }
                
                if (summary.packages.ttc > 0) {
                    if (summary.packagesGiftVoucher.ttc > 0) {
                        // Afficher le détail avec sous-catégories
                        vatSummaryData.push([
                            translate('Packages') + ' (Total)',
                            summary.packages.ht.toFixed(2) + ' €',
                            summary.packages.tva.toFixed(2) + ' €',
                            summary.packages.ttc.toFixed(2) + ' €'
                        ]);
                        vatSummaryData.push([
                            '  ' + translate('Paid by Gift Voucher'),
                            summary.packagesGiftVoucher.ht.toFixed(2) + ' €',
                            summary.packagesGiftVoucher.tva.toFixed(2) + ' €',
                            summary.packagesGiftVoucher.ttc.toFixed(2) + ' €'
                        ]);
                        vatSummaryData.push([
                            '  ' + translate('Paid by Other Methods'),
                            summary.packagesOther.ht.toFixed(2) + ' €',
                            summary.packagesOther.tva.toFixed(2) + ' €',
                            summary.packagesOther.ttc.toFixed(2) + ' €'
                        ]);
                    } else {
                        // Afficher une seule ligne "Packages"
                        vatSummaryData.push([
                            translate('Packages'),
                            summary.packages.ht.toFixed(2) + ' €',
                            summary.packages.tva.toFixed(2) + ' €',
                            summary.packages.ttc.toFixed(2) + ' €'
                        ]);
                    }
                }
                
                if (summary.products.ttc > 0) {
                    if (summary.productsGiftVoucher.ttc > 0) {
                        // Afficher le détail avec sous-catégories
                        vatSummaryData.push([
                            translate('Products') + ' (Total)',
                            summary.products.ht.toFixed(2) + ' €',
                            summary.products.tva.toFixed(2) + ' €',
                            summary.products.ttc.toFixed(2) + ' €'
                        ]);
                        vatSummaryData.push([
                            '  ' + translate('Paid by Gift Voucher'),
                            summary.productsGiftVoucher.ht.toFixed(2) + ' €',
                            summary.productsGiftVoucher.tva.toFixed(2) + ' €',
                            summary.productsGiftVoucher.ttc.toFixed(2) + ' €'
                        ]);
                        vatSummaryData.push([
                            '  ' + translate('Paid by Other Methods'),
                            summary.productsOther.ht.toFixed(2) + ' €',
                            summary.productsOther.tva.toFixed(2) + ' €',
                            summary.productsOther.ttc.toFixed(2) + ' €'
                        ]);
                    } else {
                        // Afficher une seule ligne "Products"
                        vatSummaryData.push([
                            translate('Products'),
                            summary.products.ht.toFixed(2) + ' €',
                            summary.products.tva.toFixed(2) + ' €',
                            summary.products.ttc.toFixed(2) + ' €'
                        ]);
                    }
                }
                
                if (enableSpecificProductRate && summary.specificProducts.ttc > 0) {
                    if (summary.specificProductsGiftVoucher.ttc > 0) {
                        // Afficher le détail avec sous-catégories
                        vatSummaryData.push([
                            specificProductCategoryName + ' (Total)',
                            summary.specificProducts.ht.toFixed(2) + ' €',
                            summary.specificProducts.tva.toFixed(2) + ' €',
                            summary.specificProducts.ttc.toFixed(2) + ' €'
                        ]);
                        vatSummaryData.push([
                            '  ' + translate('Paid by Gift Voucher'),
                            summary.specificProductsGiftVoucher.ht.toFixed(2) + ' €',
                            summary.specificProductsGiftVoucher.tva.toFixed(2) + ' €',
                            summary.specificProductsGiftVoucher.ttc.toFixed(2) + ' €'
                        ]);
                        vatSummaryData.push([
                            '  ' + translate('Paid by Other Methods'),
                            summary.specificProductsOther.ht.toFixed(2) + ' €',
                            summary.specificProductsOther.tva.toFixed(2) + ' €',
                            summary.specificProductsOther.ttc.toFixed(2) + ' €'
                        ]);
                    } else {
                        // Afficher une seule ligne
                        vatSummaryData.push([
                            specificProductCategoryName,
                            summary.specificProducts.ht.toFixed(2) + ' €',
                            summary.specificProducts.tva.toFixed(2) + ' €',
                            summary.specificProducts.ttc.toFixed(2) + ' €'
                        ]);
                    }
                }
                
                if (summary.giftVouchers.ttc > 0) {
                    vatSummaryData.push([
                        translate('Gift Vouchers'),
                        summary.giftVouchers.ht.toFixed(2) + ' €',
                        summary.giftVouchers.tva.toFixed(2) + ' €',
                        summary.giftVouchers.ttc.toFixed(2) + ' €'
                    ]);
                }
                
                const wsVatSummary = XLSX.utils.aoa_to_sheet(vatSummaryData);
                wsVatSummary['!cols'] = [{ wch: 40 }, { wch: 15 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, wsVatSummary, exportLanguage === 'fr' ? 'CA Détaillé' : 'Detailed Revenue');
                
                // ========================================
                // ONGLET 3: Summary Payments
                // ========================================
                if (paymentMethods) {
                    const paymentSummaryHeaders = exportLanguage === 'fr' 
                        ? ['Moyen de Paiement', 'Montant']
                        : ['Payment Method', 'Amount'];
                    
                    const paymentSummaryData = [
                        paymentSummaryHeaders,
                        [exportLanguage === 'fr' ? 'Total Encaissé' : 'Total Collected', paymentMethods.total.toFixed(2) + ' €'],
                        []
                    ];
                    
                    if (paymentMethods.cash > 0) paymentSummaryData.push([translate('Cash'), paymentMethods.cash.toFixed(2) + ' €']);
                    if (paymentMethods.instore_card > 0) paymentSummaryData.push([translate('Card (In-Store)'), paymentMethods.instore_card.toFixed(2) + ' €']);
                    if (paymentMethods.online_card > 0) paymentSummaryData.push([translate('Card (Online)'), paymentMethods.online_card.toFixed(2) + ' €']);
                    if (paymentMethods.bank_transfer > 0) paymentSummaryData.push([translate('Bank Transfer'), paymentMethods.bank_transfer.toFixed(2) + ' €']);
                    if (paymentMethods.cheque > 0) paymentSummaryData.push([translate('Check'), paymentMethods.cheque.toFixed(2) + ' €']);
                    if (paymentMethods.gift_voucher > 0) paymentSummaryData.push([translate('Gift Voucher Used'), paymentMethods.gift_voucher.toFixed(2) + ' €']);
                    if (paymentMethods.other > 0) paymentSummaryData.push([translate('Other'), paymentMethods.other.toFixed(2) + ' €']);
                    
                    const wsPaymentSummary = XLSX.utils.aoa_to_sheet(paymentSummaryData);
                    wsPaymentSummary['!cols'] = [{ wch: 30 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, wsPaymentSummary, exportLanguage === 'fr' ? 'Récap Paiements' : 'Payment Summary');
                    
                    // ========================================
                    // ONGLETS 4+: Détail par moyen de paiement
                    // ========================================
                    const createPaymentSheet = (transactionTypes, sheetName) => {
                        // Identifier les paiements remboursés (pour affichage uniquement)
                        const refundedPayments = new Set();
                        data.forEach(row => {
                            const transaction = (row.transaction || '').toLowerCase().trim();
                            if (transaction.includes('refund') || transaction.includes('remboursement')) {
                                refundedPayments.add(String(row.payment));
                            }
                        });
                        
                        // Trouver tous les payment IDs qui ont ce type de paiement (INCLURE les remboursés pour Excel)
                        const matchingPaymentIds = new Set();
                        
                        data.forEach(row => {
                            const transaction = (row.transaction || '').toLowerCase().trim();
                            const grossValue = parseFloat(row.gross_value) || 0;
                            
                            // Si c'est un paiement qui correspond au type recherché (même si remboursé)
                            if (transactionTypes.some(t => transaction.includes(t.toLowerCase().trim()))) {
                                matchingPaymentIds.add(String(row.payment));
                            }
                        });
                        
                        if (matchingPaymentIds.size === 0) return;
                        
                        // Créer les headers
                        const headers = exportLanguage === 'fr'
                            ? ['ID Paiement', 'Date', 'Transaction', 'Type', 'Montant', 'Boutique', 'Employé', 'Client', 'Notes', 'Compte Bancaire', 'Arrivée Paiement En Ligne', 'Frais Paiement En Ligne', 'URL']
                            : ['Payment ID', 'Date', 'Transaction', 'Type', 'Amount', 'Shop', 'Employee', 'Customer', 'Notes', 'Bank Account', 'Online Payment Arrival', 'Online Payment Fee', 'URL'];
                        
                        const sheetData = [headers];
                        
                        // Filtrer et afficher les lignes correspondantes
                        data.forEach(row => {
                            if (matchingPaymentIds.has(String(row.payment))) {
                                const transaction = (row.transaction || '').toLowerCase().trim();
                                const grossValue = parseFloat(row.gross_value) || 0;
                                const isRefunded = refundedPayments.has(String(row.payment));
                                
                                // Garder si :
                                // 1. C'est un appointment (service)
                                // 2. C'est un product_sale (produit)
                                // 3. C'est un package_sale (forfait)
                                // 4. C'est un gift_voucher_sale (bon cadeau)
                                // 5. C'est le type de paiement recherché (contient le type)
                                // 6. C'est une ligne "refund"
                                // 7. C'est la ligne URL
                                const isAppointment = transaction === 'appointment';
                                const isProductSale = transaction === 'product_sale';
                                const isPackageSale = transaction === 'package_sale';
                                const isGiftVoucherSale = transaction === 'gift_voucher_sale';
                                const isMatchingPayment = transactionTypes.some(t => transaction.includes(t.toLowerCase().trim()));
                                const isRefundLine = transaction.includes('refund') || transaction.includes('remboursement');
                                const isUrlLine = !transaction && !grossValue && row.url;
                                
                                if (isAppointment || isProductSale || isPackageSale || isGiftVoucherSale || isMatchingPayment || isRefundLine || isUrlLine) {
                                    sheetData.push([
                                        row.payment || '-',
                                        row['Heure et jour'] || row['datetime'] || '-',
                                        row.transaction || '-',
                                        row.type || '-',
                                        row.gross_value ? parseFloat(row.gross_value).toFixed(2) + ' €' : '-',
                                        row.shop || '-',
                                        row.employee || '-',
                                        row.customer_name || '-',
                                        row.additional_info || '-',
                                        row.bank_account ? parseFloat(row.bank_account).toFixed(2) + ' €' : '-',
                                        row.online_payment_arrival ? parseFloat(row.online_payment_arrival).toFixed(2) + ' €' : '-',
                                        row.online_payment_fee ? parseFloat(row.online_payment_fee).toFixed(2) + ' €' : '-',
                                        row.url || '-'
                                    ]);
                                }
                            }
                        });
                        
                        const ws = XLSX.utils.aoa_to_sheet(sheetData);
                        ws['!cols'] = [
                            { wch: 12 },  // ID Paiement
                            { wch: 18 },  // Date
                            { wch: 20 },  // Transaction
                            { wch: 35 },  // Type
                            { wch: 12 },  // Montant
                            { wch: 15 },  // Boutique
                            { wch: 20 },  // Employé
                            { wch: 25 },  // Client
                            { wch: 30 },  // Notes
                            { wch: 15 },  // Compte Bancaire
                            { wch: 18 },  // Arrivée Paiement En Ligne
                            { wch: 18 },  // Frais Paiement En Ligne
                            { wch: 60 }   // URL
                        ];
                        XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    };
                    
                    // Créer les onglets même si montant = 0 (pour voir les remboursements)
                    const hasTransaction = (transactionTypes) => {
                        return data.some(row => {
                            const transaction = (row.transaction || '').toLowerCase().trim();
                            return transactionTypes.some(t => transaction.includes(t.toLowerCase().trim()));
                        });
                    };
                    
                    if (hasTransaction(['cash', 'en espèces', 'espèces'])) {
                        createPaymentSheet(['cash', 'en espèces', 'espèces'], exportLanguage === 'fr' ? 'Espèces' : 'Cash');
                    }
                    if (hasTransaction(['instore card', 'par carte au salon'])) {
                        createPaymentSheet(['instore card', 'par carte au salon'], exportLanguage === 'fr' ? 'Carte Salon' : 'Card In-Store');
                    }
                    if (hasTransaction(['online_card', 'paiement par carte en ligne'])) {
                        createPaymentSheet(['online_card', 'paiement par carte en ligne'], exportLanguage === 'fr' ? 'Carte En Ligne' : 'Card Online');
                    }
                    if (hasTransaction(['bank transfer', 'virement bancaire'])) {
                        createPaymentSheet(['bank transfer', 'virement bancaire'], exportLanguage === 'fr' ? 'Virement' : 'Bank Transfer');
                    }
                    if (hasTransaction(['cheque', 'chèque'])) {
                        createPaymentSheet(['cheque', 'chèque'], exportLanguage === 'fr' ? 'Chèque' : 'Check');
                    }
                    if (hasTransaction(['gift_voucher_applied', 'gift_vouhcher_applied'])) {
                        createPaymentSheet(['gift_voucher_applied', 'gift_vouhcher_applied'], exportLanguage === 'fr' ? 'Bon Cadeau' : 'Gift Voucher');
                    }
                    if (hasTransaction(['other', 'autre'])) {
                        createPaymentSheet(['other', 'autre'], exportLanguage === 'fr' ? 'Autre' : 'Other');
                    }
                }
                // ========================================
                // ONGLET: Anomalies
                // ========================================
                const anomaliesData = calculateAnomalies();
                if (anomaliesData.length > 0) {
                    const anomaliesHeaders = exportLanguage === 'fr'
                        ? ['ID Paiement', 'Date', 'Client', 'Boutique', 'Employé', 'Services (Annulés)', 'Service Total', 'Montant Encaissé', 'TVA Calculée', 'Taux TVA', 'Action Recommandée', 'URL']
                        : ['Payment ID', 'Date', 'Customer', 'Shop', 'Employee', 'Services (Cancelled)', 'Service Total', 'Amount Collected', 'VAT Calculated', 'VAT Rate', 'Recommended Action', 'URL'];
                    
                    const anomaliesExcelData = [anomaliesHeaders];
                    
                    anomaliesData.forEach(anomaly => {
                        const servicesDescription = anomaly.items.map(item => item.type).join(', ');
                        const action = exportLanguage === 'fr' 
                            ? 'Vérifier : Frais d\'annulation ou Remboursement'
                            : 'Check: Cancellation fees or Refund';
                        
                        anomaliesExcelData.push([
                            anomaly.paymentId,
                            anomaly.date,
                            anomaly.customer,
                            anomaly.shop,
                            anomaly.employee,
                            servicesDescription,
                            anomaly.totalServices.toFixed(2) + ' €',
                            anomaly.totalPaid.toFixed(2) + ' €',
                            anomaly.vatAmount.toFixed(2) + ' €',
                            anomaly.vatRate + '%',
                            action,
                            anomaly.url
                        ]);
                    });
                    
                    const wsAnomalies = XLSX.utils.aoa_to_sheet(anomaliesExcelData);
                    wsAnomalies['!cols'] = [
                        { wch: 12 },  // ID
                        { wch: 18 },  // Date
                        { wch: 25 },  // Client
                        { wch: 20 },  // Boutique
                        { wch: 20 },  // Employé
                        { wch: 40 },  // Services
                        { wch: 12 },  // Service Total
                        { wch: 15 },  // Encaissé
                        { wch: 15 },  // TVA
                        { wch: 10 },  // Taux
                        { wch: 45 },  // Action
                        { wch: 60 }   // URL
                    ];
                    XLSX.utils.book_append_sheet(wb, wsAnomalies, exportLanguage === 'fr' ? 'Anomalies' : 'Anomalies');
                }

                // ========================================
                // ONGLET: Paiements en Attente
                // ========================================
                const pendingPaymentsData = calculatePendingPayments();
                if (pendingPaymentsData.length > 0) {
                    const pendingHeaders = exportLanguage === 'fr'
                        ? ['ID Paiement', 'Date', 'Client', 'Boutique', 'Employé', 'Services/Produits', 'Notes', 'Total Dû', 'Payé', 'Reste à Payer', 'URL']
                        : ['Payment ID', 'Date', 'Customer', 'Shop', 'Employee', 'Services/Products', 'Notes', 'Total Due', 'Paid', 'Amount Pending', 'URL'];
                    
                    const pendingData = [pendingHeaders];

                    pendingPaymentsData.forEach(payment => {
                        const servicesDescription = payment.serviceItems.map(item => item.type).join(', ');
                        const productsDescription = payment.productItems.map(item => item.type).join(', ');
                        const itemsDescription = [
                            servicesDescription && `📅 ${servicesDescription}`,
                            productsDescription && `🛍️ ${productsDescription}`
                        ].filter(Boolean).join(' | ');
                        const notes = payment.items[0]?.additional_info || '';
                        pendingData.push([
                            payment.paymentId,
                            payment.date,
                            payment.customer,
                            payment.shop,
                            payment.employee,
                            itemsDescription,
                            notes,
                            payment.totalDue.toFixed(2) + ' €',
                            payment.totalPaid.toFixed(2) + ' €',
                            payment.amountPending.toFixed(2) + ' €',
                            payment.url
                        ]);
                    });
                    
                    const wsPending = XLSX.utils.aoa_to_sheet(pendingData);
                    wsPending['!cols'] = [
                        { wch: 12 },  // ID
                        { wch: 18 },  // Date
                        { wch: 25 },  // Client
                        { wch: 20 },  // Boutique
                        { wch: 20 },  // Employé
                        { wch: 50 },  // Services/Produits
                        { wch: 30 },  // Notes
                        { wch: 12 },  // Total Dû
                        { wch: 12 },  // Payé
                        { wch: 15 },  // Reste à Payer
                        { wch: 60 }   // URL
                    ];
                    XLSX.utils.book_append_sheet(wb, wsPending, exportLanguage === 'fr' ? 'En Attente' : 'Pending');
                }
        
                // ========================================
                // TÉLÉCHARGEMENT
                // ========================================
                const suffix = exportLanguage === 'fr' ? '_Rapport_Complet' : '_Complete_Report';
                XLSX.writeFile(wb, fileName.replace('.csv', '') + suffix + '.xlsx');
            };

            const downloadPDF = () => {
                if (data.length === 0) return;
                window.print();
            };

            const getTableHeaders = () => {
                if (exportLanguage === 'fr') {
                    return ['ID', 'Date', 'Transaction', 'Type', 'Valeur', 'Catégorie', 'Taux TVA', 'Montant TVA'];
                }
                return ['ID', 'Date', 'Transaction', 'Type', 'Value', 'Category', 'VAT Rate', 'VAT Amount'];
            };

            const formatCurrency = (value) => {
                if (!value && value !== 0) return '-';
                return parseFloat(value).toFixed(2) + ' €';
            };

            const calculateSummary = () => {
            const summary = {
                total: { ht: 0, tva: 0, ttc: 0 },
                appointments: { ht: 0, tva: 0, ttc: 0 },
                appointmentsGiftVoucher: { ht: 0, tva: 0, ttc: 0 },
                appointmentsOther: { ht: 0, tva: 0, ttc: 0 },
                packages: { ht: 0, tva: 0, ttc: 0 },
                packagesGiftVoucher: { ht: 0, tva: 0, ttc: 0 },
                packagesOther: { ht: 0, tva: 0, ttc: 0 },
                products: { ht: 0, tva: 0, ttc: 0 },
                productsGiftVoucher: { ht: 0, tva: 0, ttc: 0 },
                productsOther: { ht: 0, tva: 0, ttc: 0 },
                specificProducts: { ht: 0, tva: 0, ttc: 0 },
                specificProductsGiftVoucher: { ht: 0, tva: 0, ttc: 0 },
                specificProductsOther: { ht: 0, tva: 0, ttc: 0 },
                giftVouchers: { ht: 0, tva: 0, ttc: 0 }
            };
        
            data.forEach(row => {
                // Traiter toutes les lignes qui ont une catégorie VAT
                if (row.vat_category) {
                    const ttc = parseFloat(row.gross_value) || 0;
                    const tva = parseFloat(row.vat_amount) || 0;
                    const ht = ttc - tva;
        
                    // Ajouter au total SEULEMENT si la TVA est réellement calculée
                    if (row.vat_amount && row.vat_rate !== '') {
                        summary.total.ttc += ttc;
                        summary.total.tva += tva;
                        summary.total.ht += ht;
                    }
        
                    if (row.vat_category === 'Appointment' || row.vat_category === 'Appointment (Partial Gift Voucher)' || row.vat_category === 'Appointment (Paid by Gift Voucher)') {
                        summary.appointments.ttc += ttc;
                        summary.appointments.tva += tva;
                        summary.appointments.ht += ht;
                        
                        // Calculer la part payée par bon cadeau vs autre
                        if (row.vat_category === 'Appointment (Paid by Gift Voucher)') {
                            // 100% payé par bon cadeau
                            summary.appointmentsGiftVoucher.ttc += ttc;
                            
                            // Si vat_amount existe = TVA BC à 0% donc TVA déclarée au rdv
                            // Si vat_amount vide = TVA BC > 0% donc TVA déjà déclarée à l'achat
                            if (row.vat_amount && row.vat_rate !== '') {
                                summary.appointmentsGiftVoucher.tva += tva;
                                summary.appointmentsGiftVoucher.ht += ht;
                            } else {
                                summary.appointmentsGiftVoucher.tva += 0;
                                summary.appointmentsGiftVoucher.ht += ttc;
                            }
                        } else if (row.vat_category === 'Appointment (Partial Gift Voucher)') {
                            let giftVoucherPart = 0;
                            let amountToTax = 0;
                            
                            // Extraire depuis [taxé:XX.XX€] si présent
                            const match = row.type?.match(/\[taxé:([\d.]+)€\]/);
                            if (match) {
                                // Si [taxé:XX.XX€] existe = TVA BC > 0%
                                // La TVA n'est calculée QUE sur amountToTax
                                amountToTax = parseFloat(match[1]);
                                giftVoucherPart = ttc - amountToTax;
                                
                                // Part bon cadeau (TVA = 0, déjà payée à l'achat)
                                summary.appointmentsGiftVoucher.ttc += giftVoucherPart;
                                summary.appointmentsGiftVoucher.tva += 0;
                                summary.appointmentsGiftVoucher.ht += giftVoucherPart;
                                
                                // Part autre paiement (avec TOUTE la TVA)
                                summary.appointmentsOther.ttc += amountToTax;
                                summary.appointmentsOther.tva += tva;
                                summary.appointmentsOther.ht += amountToTax - tva;
                            } else if (row._giftVoucherPart !== undefined) {
                                // Si pas de [taxé:] mais _giftVoucherPart existe = TVA BC = 0%
                                // La TVA est calculée sur TOUT, on répartit proportionnellement
                                giftVoucherPart = row._giftVoucherPart;
                                amountToTax = row._amountToTax || (ttc - giftVoucherPart);
                                
                                const giftVoucherTVA = (giftVoucherPart / ttc) * tva;
                                const otherTVA = tva - giftVoucherTVA;
                                
                                // Part bon cadeau
                                summary.appointmentsGiftVoucher.ttc += giftVoucherPart;
                                summary.appointmentsGiftVoucher.tva += giftVoucherTVA;
                                summary.appointmentsGiftVoucher.ht += giftVoucherPart - giftVoucherTVA;
                                
                                // Part autre paiement
                                summary.appointmentsOther.ttc += amountToTax;
                                summary.appointmentsOther.tva += otherTVA;
                                summary.appointmentsOther.ht += amountToTax - otherTVA;
                            }
                        } else {
                            // Appointment normal (pas de bon cadeau)
                            summary.appointmentsOther.ttc += ttc;
                            summary.appointmentsOther.tva += tva;
                            summary.appointmentsOther.ht += ht;
                        }
                    } else if (row.vat_category === 'Package' || row.vat_category === 'Package (Partial Gift Voucher)' || row.vat_category === 'Package (Paid by Gift Voucher)') {
                        summary.packages.ttc += ttc;
                        summary.packages.tva += tva;
                        summary.packages.ht += ht;
                        
                        if (row.vat_category === specificProductCategoryName + ' (Paid by Gift Voucher)') {
                            if (row.vat_amount && row.vat_rate !== '') {
                                // TVA BC = 0% : TVA déclarée au moment de l'utilisation
                                summary.specificProductsOther.ttc += ttc;
                                summary.specificProductsOther.tva += tva;
                                summary.specificProductsOther.ht += ht;
                            } else {
                                // TVA BC > 0% : TVA déclarée à l'achat du BC
                                summary.specificProductsGiftVoucher.ttc += ttc;
                                summary.specificProductsGiftVoucher.tva += 0;
                                summary.specificProductsGiftVoucher.ht += ttc;
                            }
                        } else if (row.vat_category === 'Package (Partial Gift Voucher)') {
                            let giftVoucherPart = 0;
                            let amountToTax = 0;
                            
                            const match = row.type?.match(/\[taxé:([\d.]+)€\]/);
                            if (match) {
                                // TVA BC > 0% : TVA uniquement sur amountToTax
                                amountToTax = parseFloat(match[1]);
                                giftVoucherPart = ttc - amountToTax;
                                
                                summary.packagesGiftVoucher.ttc += giftVoucherPart;
                                summary.packagesGiftVoucher.tva += 0;
                                summary.packagesGiftVoucher.ht += giftVoucherPart;
                                
                                summary.packagesOther.ttc += amountToTax;
                                summary.packagesOther.tva += tva;
                                summary.packagesOther.ht += amountToTax - tva;
                            } else if (row._giftVoucherPart !== undefined) {
                                // TVA BC = 0% : répartition proportionnelle
                                giftVoucherPart = row._giftVoucherPart;
                                amountToTax = row._amountToTax || (ttc - giftVoucherPart);
                                
                                const giftVoucherTVA = (giftVoucherPart / ttc) * tva;
                                const otherTVA = tva - giftVoucherTVA;
                                
                                summary.packagesGiftVoucher.ttc += giftVoucherPart;
                                summary.packagesGiftVoucher.tva += giftVoucherTVA;
                                summary.packagesGiftVoucher.ht += giftVoucherPart - giftVoucherTVA;
                                
                                summary.packagesOther.ttc += amountToTax;
                                summary.packagesOther.tva += otherTVA;
                                summary.packagesOther.ht += amountToTax - otherTVA;
                            }
                        } else {
                            summary.packagesOther.ttc += ttc;
                            summary.packagesOther.tva += tva;
                            summary.packagesOther.ht += ht;
                        }
                    } else if (row.vat_category === 'Product' || row.vat_category === 'Product (Partial Gift Voucher)' || row.vat_category === 'Product (Paid by Gift Voucher)') {
                        summary.products.ttc += ttc;
                        summary.products.tva += tva;
                        summary.products.ht += ht;
                        
                        if (row.vat_category === 'Product (Paid by Gift Voucher)') {
                            summary.productsGiftVoucher.ttc += ttc;
                            
                            // Si vat_amount existe = TVA BC à 0% donc TVA déclarée au moment de l'utilisation
                            // Si vat_amount vide = TVA BC > 0% donc TVA déjà déclarée à l'achat
                            if (row.vat_amount && row.vat_rate !== '') {
                                summary.productsGiftVoucher.tva += tva;
                                summary.productsGiftVoucher.ht += ht;
                            } else {
                                summary.productsGiftVoucher.tva += 0;
                                summary.productsGiftVoucher.ht += ttc;
                            }
                        } else if (row.vat_category === 'Product (Partial Gift Voucher)') {
                            let giftVoucherPart = 0;
                            let amountToTax = 0;
                            
                            const match = row.type?.match(/\[taxé:([\d.]+)€\]/);
                            if (match) {
                                // TVA BC > 0% : TVA uniquement sur amountToTax
                                amountToTax = parseFloat(match[1]);
                                giftVoucherPart = ttc - amountToTax;
                                
                                summary.productsGiftVoucher.ttc += giftVoucherPart;
                                summary.productsGiftVoucher.tva += 0;
                                summary.productsGiftVoucher.ht += giftVoucherPart;
                                
                                summary.productsOther.ttc += amountToTax;
                                summary.productsOther.tva += tva;
                                summary.productsOther.ht += amountToTax - tva;
                            } else if (row._giftVoucherPart !== undefined) {
                                // TVA BC = 0% : répartition proportionnelle
                                giftVoucherPart = row._giftVoucherPart;
                                amountToTax = row._amountToTax || (ttc - giftVoucherPart);
                                
                                const giftVoucherTVA = (giftVoucherPart / ttc) * tva;
                                const otherTVA = tva - giftVoucherTVA;
                                
                                summary.productsGiftVoucher.ttc += giftVoucherPart;
                                summary.productsGiftVoucher.tva += giftVoucherTVA;
                                summary.productsGiftVoucher.ht += giftVoucherPart - giftVoucherTVA;
                                
                                summary.productsOther.ttc += amountToTax;
                                summary.productsOther.tva += otherTVA;
                                summary.productsOther.ht += amountToTax - otherTVA;
                            }
                        } else {
                            summary.productsOther.ttc += ttc;
                            summary.productsOther.tva += tva;
                            summary.productsOther.ht += ht;
                        }
                    } else if (row.vat_category === specificProductCategoryName || row.vat_category === specificProductCategoryName + ' (Partial Gift Voucher)' || row.vat_category === specificProductCategoryName + ' (Paid by Gift Voucher)') {
                        summary.specificProducts.ttc += ttc;
                        summary.specificProducts.tva += tva;
                        summary.specificProducts.ht += ht;
                        
                        if (row.vat_category === specificProductCategoryName + ' (Paid by Gift Voucher)') {
                            summary.specificProductsGiftVoucher.ttc += ttc;
                            
                            if (row.vat_amount && row.vat_rate !== '') {
                                summary.specificProductsGiftVoucher.tva += tva;
                                summary.specificProductsGiftVoucher.ht += ht;
                            } else {
                                summary.specificProductsGiftVoucher.tva += 0;
                                summary.specificProductsGiftVoucher.ht += ttc;
                            }
                        } else if (row.vat_category === specificProductCategoryName + ' (Partial Gift Voucher)') {
                            let giftVoucherPart = 0;
                            let amountToTax = 0;
                            
                            const match = row.type?.match(/\[taxé:([\d.]+)€\]/);
                            if (match) {
                                // TVA BC > 0% : TVA uniquement sur amountToTax
                                amountToTax = parseFloat(match[1]);
                                giftVoucherPart = ttc - amountToTax;
                                
                                summary.specificProductsGiftVoucher.ttc += giftVoucherPart;
                                summary.specificProductsGiftVoucher.tva += 0;
                                summary.specificProductsGiftVoucher.ht += giftVoucherPart;
                                
                                summary.specificProductsOther.ttc += amountToTax;
                                summary.specificProductsOther.tva += tva;
                                summary.specificProductsOther.ht += amountToTax - tva;
                            } else if (row._giftVoucherPart !== undefined) {
                                // TVA BC = 0% : répartition proportionnelle
                                giftVoucherPart = row._giftVoucherPart;
                                amountToTax = row._amountToTax || (ttc - giftVoucherPart);
                                
                                const giftVoucherTVA = (giftVoucherPart / ttc) * tva;
                                const otherTVA = tva - giftVoucherTVA;
                                
                                summary.specificProductsGiftVoucher.ttc += giftVoucherPart;
                                summary.specificProductsGiftVoucher.tva += giftVoucherTVA;
                                summary.specificProductsGiftVoucher.ht += giftVoucherPart - giftVoucherTVA;
                                
                                summary.specificProductsOther.ttc += amountToTax;
                                summary.specificProductsOther.tva += otherTVA;
                                summary.specificProductsOther.ht += amountToTax - otherTVA;
                            }
                        } else {
                            summary.specificProductsOther.ttc += ttc;
                            summary.specificProductsOther.tva += tva;
                            summary.specificProductsOther.ht += ht;
                        }
                    } else if (row.vat_category === 'Gift Voucher') {
                        summary.giftVouchers.ttc += ttc;
                        summary.giftVouchers.tva += tva;
                        summary.giftVouchers.ht += ht;
                    }
                }
            });
        
            return summary;
        };
            
            const translate = (key) => {
                    if (exportLanguage === 'fr') {
                        return {
                            'Total Period': 'Total Période',
                            'Total Period (Excl. Gift Voucher Payments)': 'Total Période (Hors Paiements par Bon Cadeau)',
                            'Appointments': 'Rendez-vous',
                            'Appointments (Total)': 'Rendez-vous (Total)',
                            'Paid by Gift Voucher': 'Payés par Bon Cadeau',
                            'Paid by Other Methods': 'Payés via Mode de Paiement Standard (hors Bon Cadeau)',
                            'Packages': 'Forfaits',
                            'Appointments (Paid by Gift Voucher)': 'Rendez-vous (Payés par Bon Cadeau)',
                            'Products': 'Produits',
                            'Gift Vouchers': 'Bons Cadeaux',
                            'Excl. VAT': 'HT',
                            'VAT': 'TVA',
                            'Incl. VAT': 'TTC',
                            'Payment Methods Breakdown': 'Répartition par Moyen de Paiement',
                            'Total Collected': 'Total Encaissé',
                            'Cash': 'Espèces',
                            'Card (In-Store)': 'Carte au Salon',
                            'Bank Transfer': 'Virement Bancaire',
                            'Check': 'Chèque',
                            'Other': 'Autre',
                            'Gift Voucher Used': 'Bon Cadeau Utilisé',
                            'Card (Online)': 'Carte en Ligne'
                        }[key] || key;
                    }
                    // Version anglaise
                    return {
                        'Paid by Other Methods': 'Paid via Standard Payment Methods (excl. Gift Vouchers)'
                    }[key] || key;
                };
                const calculatePaymentMethods = () => {
                    const payments = {
                        cash: 0,
                        instore_card: 0,
                        bank_transfer: 0,
                        cheque: 0,
                        other: 0,
                        gift_voucher: 0,
                        online_card: 0,
                        total: 0
                    };
                    
                    // Identifier les paiements remboursés (transaction contient "refunded")
                    const refundedPayments = new Set();
                    data.forEach(row => {
                        const transaction = row.transaction?.toLowerCase() || '';
                        if (transaction.includes('refund') || transaction.includes('remboursement')) {
                            refundedPayments.add(row.payment);
                        }
                    });
                    
                    // Grouper par payment ID et calculer le net (négatifs + positifs)
                    const paymentNets = {};
                    data.forEach(row => {
                        const transaction = row.transaction?.toLowerCase() || '';
                        const grossValue = parseFloat(row.gross_value) || 0;
                        const paymentId = row.payment;
                        
                        // Ignorer les paiements remboursés
                        if (refundedPayments.has(paymentId)) {
                            return;
                        }
                        
                        // Calculer le montant net par type de transaction
                        if (transaction === 'cash' || transaction === 'en espèces' || transaction === 'espèces') {
                            if (!paymentNets[paymentId]) paymentNets[paymentId] = { cash: 0, instore_card: 0, bank_transfer: 0, cheque: 0, other: 0, gift_voucher: 0, online_card: 0 };
                            paymentNets[paymentId].cash += grossValue;
                        } else if (transaction === 'instore card' || transaction === 'par carte au salon') {
                            if (!paymentNets[paymentId]) paymentNets[paymentId] = { cash: 0, instore_card: 0, bank_transfer: 0, cheque: 0, other: 0, gift_voucher: 0, online_card: 0 };
                            paymentNets[paymentId].instore_card += grossValue;
                        } else if (transaction === 'bank transfer' || transaction === 'virement bancaire') {
                            if (!paymentNets[paymentId]) paymentNets[paymentId] = { cash: 0, instore_card: 0, bank_transfer: 0, cheque: 0, other: 0, gift_voucher: 0, online_card: 0 };
                            paymentNets[paymentId].bank_transfer += grossValue;
                        } else if (transaction === 'cheque' || transaction === 'chèque') {
                            if (!paymentNets[paymentId]) paymentNets[paymentId] = { cash: 0, instore_card: 0, bank_transfer: 0, cheque: 0, other: 0, gift_voucher: 0, online_card: 0 };
                            paymentNets[paymentId].cheque += grossValue;
                        } else if (transaction === 'other' || transaction === 'autre') {
                            if (!paymentNets[paymentId]) paymentNets[paymentId] = { cash: 0, instore_card: 0, bank_transfer: 0, cheque: 0, other: 0, gift_voucher: 0, online_card: 0 };
                            paymentNets[paymentId].other += grossValue;
                        } else if (transaction === 'gift_voucher_applied' || transaction === 'gift_vouhcher_applied') {
                            if (!paymentNets[paymentId]) paymentNets[paymentId] = { cash: 0, instore_card: 0, bank_transfer: 0, cheque: 0, other: 0, gift_voucher: 0, online_card: 0 };
                            paymentNets[paymentId].gift_voucher += grossValue;
                        } else if (transaction === 'online_card_payment' || transaction === 'paiement par carte en ligne') {
                            if (!paymentNets[paymentId]) paymentNets[paymentId] = { cash: 0, instore_card: 0, bank_transfer: 0, cheque: 0, other: 0, gift_voucher: 0, online_card: 0 };
                            paymentNets[paymentId].online_card += grossValue;
                        }
                    });
                    
                    // Additionner les montants nets (seulement si négatif = paiement effectif)
                    Object.values(paymentNets).forEach(net => {
                        if (net.cash < 0) { payments.cash += Math.abs(net.cash); payments.total += Math.abs(net.cash); }
                        if (net.instore_card < 0) { payments.instore_card += Math.abs(net.instore_card); payments.total += Math.abs(net.instore_card); }
                        if (net.bank_transfer < 0) { payments.bank_transfer += Math.abs(net.bank_transfer); payments.total += Math.abs(net.bank_transfer); }
                        if (net.cheque < 0) { payments.cheque += Math.abs(net.cheque); payments.total += Math.abs(net.cheque); }
                        if (net.other < 0) { payments.other += Math.abs(net.other); payments.total += Math.abs(net.other); }
                        if (net.gift_voucher < 0) { payments.gift_voucher += Math.abs(net.gift_voucher); payments.total += Math.abs(net.gift_voucher); }
                        if (net.online_card < 0) { payments.online_card += Math.abs(net.online_card); payments.total += Math.abs(net.online_card); }
                    });
                    
                    return payments;
                };
                const calculatePendingPayments = () => {
                    const pendingPayments = [];
                    const paymentGroups = {};
                    
                    // Grouper par payment ID
                    data.forEach(row => {
                        const paymentId = row.payment;
                        if (!paymentGroups[paymentId]) {
                            paymentGroups[paymentId] = [];
                        }
                        paymentGroups[paymentId].push(row);
                    });
                    
                    // Identifier les paiements remboursés
                    const refundedPayments = new Set();
                    data.forEach(row => {
                        const transaction = row.transaction?.toLowerCase() || '';
                        if (transaction.includes('refund') || transaction.includes('remboursement')) {
                            refundedPayments.add(row.payment);
                        }
                    });
                    
                    // Analyser chaque groupe de paiement
                    Object.keys(paymentGroups).forEach(paymentId => {
                        const group = paymentGroups[paymentId];
                        
                        // Ignorer les paiements remboursés
                        if (refundedPayments.has(paymentId)) {
                            return;
                        }
                        
                        // Calculer le total des services/produits (positif) - SÉPARÉ
                        let totalDueServices = 0;
                        let totalDueProducts = 0;
                        const serviceItems = [];
                        const productItems = [];
                        
                        group.forEach(row => {
                            const transaction = row.transaction?.toLowerCase() || '';
                            const grossValue = parseFloat(row.gross_value) || 0;
                            
                            if (grossValue > 0) {
                                if (transaction === 'appointment' || transaction === 'package_sale') {
                                    totalDueServices += grossValue;
                                    serviceItems.push(row);
                                } else if (transaction === 'product_sale' || transaction === 'gift_voucher_sale') {
                                    totalDueProducts += grossValue;
                                    productItems.push(row);
                                }
                            }
                        });
                        
                        const totalDue = totalDueServices + totalDueProducts;
                        const allItems = [...serviceItems, ...productItems];
                        
                        // Calculer le total des paiements (somme algébrique pour gérer les annulations)
                        let totalPaid = 0;
                        const paymentsByType = {};
                        
                        group.forEach(row => {
                            const transaction = row.transaction?.toLowerCase() || '';
                            const grossValue = parseFloat(row.gross_value) || 0;
                            
                            // Tous les paiements (négatifs et positifs si annulation)
                            if (transaction !== 'appointment' && 
                                transaction !== 'product_sale' && 
                                transaction !== 'package_sale' &&
                                transaction !== 'gift_voucher_sale' &&
                                grossValue !== 0 &&
                                !transaction.includes('refund')) {
                                
                                if (!paymentsByType[transaction]) {
                                    paymentsByType[transaction] = 0;
                                }
                                paymentsByType[transaction] += grossValue;
                            }
                        });
                        
                        // Calculer le total réellement payé (somme des valeurs négatives nettes)
                        Object.values(paymentsByType).forEach(amount => {
                            if (amount < 0) {
                                totalPaid += Math.abs(amount);
                            }
                        });
                        
                        // Si le montant payé est inférieur au montant dû
                        const amountPending = totalDue - totalPaid;
                        
                        if (amountPending > 0.01) { // Seuil de 1 centime pour éviter les erreurs d'arrondi
                            pendingPayments.push({
                                paymentId: paymentId,
                                totalDue: totalDue,
                                totalDueServices: totalDueServices,
                                totalDueProducts: totalDueProducts,
                                totalPaid: totalPaid,
                                amountPending: amountPending,
                                items: allItems,
                                serviceItems: serviceItems,
                                productItems: productItems,
                                date: allItems[0]?.['Heure et jour'] || allItems[0]?.['datetime'] || allItems[0]?.['Date and time'] || '',
                                customer: allItems[0]?.customer_name || '',
                                shop: allItems[0]?.shop || '',
                                employee: allItems[0]?.employee || '',
                                url: group.find(r => r.url)?.url || ''
                            });
                        }
                    });
                    
                    return pendingPayments;
                };
            const calculateAnomalies = () => {
                const anomalies = [];
                const paymentGroups = {};
                
                // Grouper par payment ID
                data.forEach(row => {
                    const paymentId = row.payment;
                    if (!paymentGroups[paymentId]) {
                        paymentGroups[paymentId] = [];
                    }
                    paymentGroups[paymentId].push(row);
                });
                
                // Identifier les paiements remboursés
                const refundedPayments = new Set();
                data.forEach(row => {
                    const transaction = row.transaction?.toLowerCase() || '';
                    if (transaction.includes('refund') || transaction.includes('remboursement')) {
                        refundedPayments.add(row.payment);
                    }
                });
                
                // Analyser chaque groupe
                Object.keys(paymentGroups).forEach(paymentId => {
                    const group = paymentGroups[paymentId];
                    
                    // Ignorer les paiements remboursés
                    if (refundedPayments.has(paymentId)) {
                        return;
                    }
                    
                    // Calculer le total des services/produits
                    let totalServices = 0;
                    const serviceItems = [];
                    
                    group.forEach(row => {
                        const transaction = row.transaction?.toLowerCase() || '';
                        const grossValue = parseFloat(row.gross_value) || 0;
                        
                        if ((transaction === 'appointment' || transaction === 'product_sale' || transaction === 'package_sale' || transaction === 'gift_voucher_sale') && grossValue >= 0) {
                            totalServices += grossValue;
                            if (grossValue === 0) {
                                serviceItems.push(row);
                            }
                        }
                    });
                    
                    // Calculer le total réellement encaissé (net des annulations)
                    let totalPaid = 0;
                    const paymentsByType = {};
                    
                    group.forEach(row => {
                        const transaction = row.transaction?.toLowerCase() || '';
                        const grossValue = parseFloat(row.gross_value) || 0;
                        
                        if (transaction !== 'appointment' && 
                            transaction !== 'product_sale' && 
                            grossValue !== 0 &&
                            !transaction.includes('refund')) {
                            
                            if (!paymentsByType[transaction]) {
                                paymentsByType[transaction] = 0;
                            }
                            paymentsByType[transaction] += grossValue;
                        }
                    });
                    
                    // Calculer le total réellement payé (somme des valeurs négatives nettes)
                    Object.values(paymentsByType).forEach(amount => {
                        if (amount < 0) {
                            totalPaid += Math.abs(amount);
                        }
                    });
                    
                    // Anomalie : Service = 0€ MAIS paiement encaissé
                    if (totalServices === 0 && totalPaid > 0 && serviceItems.length > 0) {
                        // Calculer la TVA sur le montant encaissé
                        const vatAmount = (totalPaid * (vatRateAppointment / (100 + vatRateAppointment)));
                        
                        anomalies.push({
                            paymentId: paymentId,
                            totalServices: totalServices,
                            totalPaid: totalPaid,
                            vatAmount: vatAmount,
                            vatRate: vatRateAppointment,
                            items: serviceItems,
                            date: serviceItems[0]?.['Heure et jour'] || serviceItems[0]?.['datetime'] || serviceItems[0]?.['Date and time'] || '',
                            customer: serviceItems[0]?.customer_name || '',
                            shop: serviceItems[0]?.shop || '',
                            employee: serviceItems[0]?.employee || '',
                            url: group.find(r => r.url)?.url || ''
                        });
                    }
                });
                
                return anomalies;
            };
                    
            const summary = data.length > 0 ? calculateSummary() : null;
            const paymentMethods = data.length > 0 ? calculatePaymentMethods() : null;
            const pendingPayments = data.length > 0 ? calculatePendingPayments() : null;
            const anomalies = data.length > 0 ? calculateAnomalies() : null;

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow-lg p-8 mb-6 no-print">
                            <div className="flex items-center gap-3 mb-6">
                                <FileText />
                                <h1 className="text-3xl font-bold text-gray-800">Advanced Payment Report</h1>
                            </div>
                            
                            <p className="text-gray-600 mb-6">
                                Import your payment CSV file to automatically calculate VAT. <strong>VAT is only calculated for paid transactions.</strong>
                                <br/>
                                <span className="text-sm mt-2 block text-indigo-600">
                                    ✨ <strong>Automatic detection:</strong> Products, packages, and gift vouchers are automatically identified from the transaction type.
                                </span>
                            </p>

                            <div className="mb-6 bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                                <h3 className="text-lg font-semibold text-indigo-900 mb-4">VAT Rates Configuration</h3>
                                
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div className="bg-white rounded-lg p-4 border border-indigo-200">
                                        <label className="block text-sm font-semibold text-green-800 mb-3">📅 Appointments & Packages</label>
                                        <div className="flex gap-2 mb-3">
                                            <button onClick={() => setVatRateAppointment(5.5)} className={`px-3 py-2 rounded-lg text-sm font-medium ${vatRateAppointment === 5.5 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>5.5%</button>
                                            <button onClick={() => setVatRateAppointment(10)} className={`px-3 py-2 rounded-lg text-sm font-medium ${vatRateAppointment === 10 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>10%</button>
                                            <button onClick={() => setVatRateAppointment(20)} className={`px-3 py-2 rounded-lg text-sm font-medium ${vatRateAppointment === 20 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>20%</button>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-sm text-gray-700">Custom:</span>
                                            <input type="number" min="0" max="100" step="0.1" value={vatRateAppointment} onChange={(e) => setVatRateAppointment(parseFloat(e.target.value) || 0)} className="w-20 px-2 py-1 text-sm border border-gray-300 rounded"/>
                                            <span className="text-sm text-gray-700">%</span>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-lg p-4 border border-indigo-200">
                                        <label className="block text-sm font-semibold text-blue-800 mb-3">🛍️ Physical Products</label>
                                        <p className="text-xs text-gray-700 mb-2 font-medium">Generic rate:</p>
                                        <div className="flex gap-2 mb-2">
                                            <button onClick={() => setVatRateProduct(5.5)} className={`px-3 py-2 rounded-lg text-sm font-medium ${vatRateProduct === 5.5 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>5.5%</button>
                                            <button onClick={() => setVatRateProduct(10)} className={`px-3 py-2 rounded-lg text-sm font-medium ${vatRateProduct === 10 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>10%</button>
                                            <button onClick={() => setVatRateProduct(20)} className={`px-3 py-2 rounded-lg text-sm font-medium ${vatRateProduct === 20 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>20%</button>
                                        </div>
                                        <div className="flex items-center gap-2 mb-3">
                                            <span className="text-sm text-gray-700">Custom:</span>
                                            <input type="number" min="0" max="100" step="0.1" value={vatRateProduct} onChange={(e) => setVatRateProduct(parseFloat(e.target.value) || 0)} className="w-20 px-2 py-1 text-sm border border-gray-300 rounded"/>
                                            <span className="text-sm text-gray-700">%</span>
                                        </div>
                                        
                                        <div className="border-t border-gray-200 pt-3 mt-3">
                                            <label className="flex items-center gap-2 mb-2 cursor-pointer">
                                                <input type="checkbox" checked={enableSpecificProductRate} onChange={(e) => setEnableSpecificProductRate(e.target.checked)} className="w-4 h-4"/>
                                                <span className="text-xs font-medium text-gray-700">Enable specific rate</span>
                                            </label>

                                            {enableSpecificProductRate && (
                                                <div className="ml-6 space-y-2">
                                                    <input type="text" value={specificProductCategoryName} onChange={(e) => setSpecificProductCategoryName(e.target.value)} placeholder="Category name" className="w-full px-2 py-1 text-xs border rounded"/>
                                                    
                                                    <div className="flex gap-2">
                                                        <button onClick={() => setVatRateProductSpecific(0)} className={`px-2 py-1 rounded text-xs ${vatRateProductSpecific === 0 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}>0%</button>
                                                        <button onClick={() => setVatRateProductSpecific(5.5)} className={`px-2 py-1 rounded text-xs ${vatRateProductSpecific === 5.5 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}>5.5%</button>
                                                        <button onClick={() => setVatRateProductSpecific(10)} className={`px-2 py-1 rounded text-xs ${vatRateProductSpecific === 10 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}>10%</button>
                                                        <button onClick={() => setVatRateProductSpecific(20)} className={`px-2 py-1 rounded text-xs ${vatRateProductSpecific === 20 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}>20%</button>
                                                    </div>
                                                    
                                                    <input type="number" min="0" max="100" step="0.1" value={vatRateProductSpecific} onChange={(e) => setVatRateProductSpecific(parseFloat(e.target.value) || 0)} placeholder="Custom" className="w-20 px-2 py-1 text-xs border rounded"/>
                                                    
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-700 mb-1">Product names:</label>
                                                        <textarea value={specificProductKeywords} onChange={(e) => setSpecificProductKeywords(e.target.value)} rows="3" placeholder="Enter exact product names separated by commas" className="w-full px-2 py-1 text-xs border rounded"/>
                                                        <p className="text-xs text-gray-500 mt-1">List the exact product names (as they appear in your file) that should use the specific rate</p>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-lg p-4 border border-indigo-200">
                                        <label className="block text-sm font-semibold text-purple-800 mb-3">🎁 Gift Vouchers</label>
                                        <div className="bg-yellow-50 border border-yellow-200 rounded p-2 mb-3">
                                            <p className="text-xs text-yellow-800">
                                                <strong>⚠️ Important: Check with the client when VAT should be declared:</strong>
                                                <br/>• <strong>At voucher purchase</strong> → Set appropriate rate
                                                <br/>• <strong>At voucher use</strong> → Keep at 0% (VAT will be declared when used)
                                            </p>
                                        </div>
                                        <div className="flex gap-2 mb-3">
                                            <button onClick={() => setVatRateGiftVoucher(0)} className={`px-3 py-2 rounded-lg text-sm font-medium ${vatRateGiftVoucher === 0 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>0%</button>
                                            <button onClick={() => setVatRateGiftVoucher(5.5)} className={`px-3 py-2 rounded-lg text-sm font-medium ${vatRateGiftVoucher === 5.5 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>5.5%</button>
                                            <button onClick={() => setVatRateGiftVoucher(10)} className={`px-3 py-2 rounded-lg text-sm font-medium ${vatRateGiftVoucher === 10 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>10%</button>
                                            <button onClick={() => setVatRateGiftVoucher(20)} className={`px-3 py-2 rounded-lg text-sm font-medium ${vatRateGiftVoucher === 20 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>20%</button>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-sm text-gray-700">Custom:</span>
                                            <input type="number" min="0" max="100" step="0.1" value={vatRateGiftVoucher} onChange={(e) => setVatRateGiftVoucher(parseFloat(e.target.value) || 0)} className="w-20 px-2 py-1 text-sm border rounded"/>
                                            <span className="text-sm">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-3 mb-6">
                                <label className="flex-1 min-w-[200px] cursor-pointer">
                                    <div className="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg">
                                        <Upload />
                                        <span>Load CSV File</span>
                                    </div>
                                    <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden"/>
                                </label>

                                {data.length > 0 && (
                                    <>
                                        <div className="flex items-center gap-2 px-4 py-2 bg-gray-100 rounded-lg">
                                            <span className="text-sm font-medium">Export:</span>
                                            <button onClick={() => setExportLanguage('en')} className={`px-3 py-1 rounded text-sm ${exportLanguage === 'en' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700'}`}>🇬🇧 EN</button>
                                            <button onClick={() => setExportLanguage('fr')} className={`px-3 py-1 rounded text-sm ${exportLanguage === 'fr' ? 'bg-indigo-600 text-white' : 'bg-white text-gray-700'}`}>🇫🇷 FR</button>
                                        </div>

                                        <button onClick={downloadCSV} className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg">
                                            <FileText />
                                            <span>CSV</span>
                                        </button>

                                        <button onClick={downloadExcel} className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg">
                                            <FileSpreadsheet />
                                            <span>Excel</span>
                                        </button>

                                        <button onClick={downloadPDF} className="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg">
                                            <FileType />
                                            <span>Print</span>
                                        </button>
                                    </>
                                )}
                            </div>

                            {fileName && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                    <p className="text-blue-800"><strong>File loaded:</strong> {fileName} {data.length > 0 && `(${data.length} rows)`}</p>
                                </div>
                            )}

                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                                    <p className="text-red-800">{error}</p>
                                </div>
                            )}
                        </div>

                        {data.length > 0 && summary && (
                            <>
                                <div className="bg-white rounded-lg shadow-lg p-6 mb-6 print-section">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4">📊 {exportLanguage === 'fr' ? 'Chiffre d\'Affaires Détaillé' : 'Detailed Revenue'}</h2>
                                    
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-indigo-600 text-white">
                                                <tr>
                                                    <th className="px-4 py-3 text-left">{exportLanguage === 'fr' ? 'Catégorie' : 'Category'}</th>
                                                    <th className="px-4 py-3 text-right">{exportLanguage === 'fr' ? 'HT' : 'Excl. VAT'}</th>
                                                    <th className="px-4 py-3 text-right">{exportLanguage === 'fr' ? 'TVA' : 'VAT'}</th>
                                                    <th className="px-4 py-3 text-right">{exportLanguage === 'fr' ? 'TTC' : 'Incl. VAT'}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                               <tr className="bg-indigo-50 border-b-2 border-indigo-600">
                                                    <td className="px-4 py-3 font-bold text-indigo-900">{translate('Total Period')}</td>
                                                    <td className="px-4 py-3 text-right font-bold text-indigo-900">{formatCurrency(summary.total.ht)}</td>
                                                    <td className="px-4 py-3 text-right font-bold text-indigo-900">{formatCurrency(summary.total.tva)}</td>
                                                    <td className="px-4 py-3 text-right font-bold text-indigo-900">{formatCurrency(summary.total.ttc)}</td>
                                                </tr>
                                                {summary.appointmentsGiftVoucher.ttc > 0 && (
                                                    <tr className="bg-blue-50 border-b-2 border-blue-600">
                                                        <td className="px-4 py-3 font-bold text-blue-900">{translate('Total Period (Excl. Gift Voucher Payments)')}</td>
                                                        <td className="px-4 py-3 text-right font-bold text-blue-900">{formatCurrency(summary.total.ht - summary.appointmentsGiftVoucher.ht - summary.packagesGiftVoucher.ht - summary.productsGiftVoucher.ht - summary.specificProductsGiftVoucher.ht)}</td>
                                                        <td className="px-4 py-3 text-right font-bold text-blue-900">{formatCurrency(summary.total.tva)}</td>
                                                        <td className="px-4 py-3 text-right font-bold text-blue-900">{formatCurrency(summary.total.ttc - summary.appointmentsGiftVoucher.ttc - summary.packagesGiftVoucher.ttc - summary.productsGiftVoucher.ttc - summary.specificProductsGiftVoucher.ttc)}</td>
                                                    </tr>
                                                )}
                                                
                                                {summary.appointments.ttc > 0 && (
                                                    <>
                                                        {summary.appointmentsGiftVoucher.ttc > 0 ? (
                                                            <>
                                                                <tr className="bg-green-50 hover:bg-green-100 border-b border-green-200">
                                                                    <td className="px-4 py-3 text-green-800 font-bold">📅 {translate('Appointments (Total)')}</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.appointments.ht)}</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.appointments.tva)}</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.appointments.ttc)}</td>
                                                                </tr>
                                                                <tr className="bg-green-50 hover:bg-green-100">
                                                                    <td className="px-4 py-3 text-green-700 pl-8">↳ {translate('Paid by Gift Voucher')}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.appointmentsGiftVoucher.ht)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.appointmentsGiftVoucher.tva)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.appointmentsGiftVoucher.ttc)}</td>
                                                                </tr>
                                                                <tr className="bg-green-50 hover:bg-green-100">
                                                                    <td className="px-4 py-3 text-green-700 pl-8">↳ {translate('Paid by Other Methods')}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.appointmentsOther.ht)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.appointmentsOther.tva)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.appointmentsOther.ttc)}</td>
                                                                </tr>
                                                            </>
                                                        ) : (
                                                            <tr className="bg-green-50 hover:bg-green-100">
                                                                <td className="px-4 py-3 text-green-800">📅 {translate('Appointments')}</td>
                                                                <td className="px-4 py-3 text-right">{formatCurrency(summary.appointments.ht)}</td>
                                                                <td className="px-4 py-3 text-right">{formatCurrency(summary.appointments.tva)}</td>
                                                                <td className="px-4 py-3 text-right font-semibold">{formatCurrency(summary.appointments.ttc)}</td>
                                                            </tr>
                                                        )}
                                                    </>
                                                )}
                                                
                                                {summary.packages.ttc > 0 && (
                                                    <>
                                                        {summary.packagesGiftVoucher.ttc > 0 ? (
                                                            <>
                                                                <tr className="bg-green-50 hover:bg-green-100 border-b border-green-200">
                                                                    <td className="px-4 py-3 text-green-800 font-bold">📦 {translate('Packages')} (Total)</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.packages.ht)}</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.packages.tva)}</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.packages.ttc)}</td>
                                                                </tr>
                                                                <tr className="bg-green-50 hover:bg-green-100">
                                                                    <td className="px-4 py-3 text-green-700 pl-8">↳ {translate('Paid by Gift Voucher')}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.packagesGiftVoucher.ht)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.packagesGiftVoucher.tva)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.packagesGiftVoucher.ttc)}</td>
                                                                </tr>
                                                                <tr className="bg-green-50 hover:bg-green-100">
                                                                    <td className="px-4 py-3 text-green-700 pl-8">↳ {translate('Paid by Other Methods')}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.packagesOther.ht)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.packagesOther.tva)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.packagesOther.ttc)}</td>
                                                                </tr>
                                                            </>
                                                        ) : (
                                                            <tr className="bg-green-50 hover:bg-green-100">
                                                                <td className="px-4 py-3 text-green-800">📦 {translate('Packages')}</td>
                                                                <td className="px-4 py-3 text-right">{formatCurrency(summary.packages.ht)}</td>
                                                                <td className="px-4 py-3 text-right">{formatCurrency(summary.packages.tva)}</td>
                                                                <td className="px-4 py-3 text-right font-semibold">{formatCurrency(summary.packages.ttc)}</td>
                                                            </tr>
                                                        )}
                                                    </>
                                                )}
                                                
                                                {summary.products.ttc > 0 && (
                                                    <>
                                                        {summary.productsGiftVoucher.ttc > 0 ? (
                                                            <>
                                                                <tr className="bg-blue-50 hover:bg-blue-100 border-b border-blue-200">
                                                                    <td className="px-4 py-3 text-blue-800 font-bold">🛍️ {translate('Products')} (Total)</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.products.ht)}</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.products.tva)}</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.products.ttc)}</td>
                                                                </tr>
                                                                <tr className="bg-blue-50 hover:bg-blue-100">
                                                                    <td className="px-4 py-3 text-blue-700 pl-8">↳ {translate('Paid by Gift Voucher')}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.productsGiftVoucher.ht)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.productsGiftVoucher.tva)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.productsGiftVoucher.ttc)}</td>
                                                                </tr>
                                                                <tr className="bg-blue-50 hover:bg-blue-100">
                                                                    <td className="px-4 py-3 text-blue-700 pl-8">↳ {translate('Paid by Other Methods')}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.productsOther.ht)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.productsOther.tva)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.productsOther.ttc)}</td>
                                                                </tr>
                                                            </>
                                                        ) : (
                                                            <tr className="bg-blue-50 hover:bg-blue-100">
                                                                <td className="px-4 py-3 text-blue-800">🛍️ {translate('Products')}</td>
                                                                <td className="px-4 py-3 text-right">{formatCurrency(summary.products.ht)}</td>
                                                                <td className="px-4 py-3 text-right">{formatCurrency(summary.products.tva)}</td>
                                                                <td className="px-4 py-3 text-right font-semibold">{formatCurrency(summary.products.ttc)}</td>
                                                            </tr>
                                                        )}
                                                    </>
                                                )}
                                                
                                                {enableSpecificProductRate && summary.specificProducts.ttc > 0 && (
                                                    <>
                                                        {summary.specificProductsGiftVoucher.ttc > 0 ? (
                                                            <>
                                                                <tr className="bg-cyan-50 hover:bg-cyan-100 border-b border-cyan-200">
                                                                    <td className="px-4 py-3 text-cyan-800 font-bold">🛍️ {specificProductCategoryName} (Total)</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.specificProducts.ht)}</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.specificProducts.tva)}</td>
                                                                    <td className="px-4 py-3 text-right font-bold">{formatCurrency(summary.specificProducts.ttc)}</td>
                                                                </tr>
                                                                <tr className="bg-cyan-50 hover:bg-cyan-100">
                                                                    <td className="px-4 py-3 text-cyan-700 pl-8">↳ {translate('Paid by Gift Voucher')}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.specificProductsGiftVoucher.ht)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.specificProductsGiftVoucher.tva)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.specificProductsGiftVoucher.ttc)}</td>
                                                                </tr>
                                                                <tr className="bg-cyan-50 hover:bg-cyan-100">
                                                                    <td className="px-4 py-3 text-cyan-700 pl-8">↳ {translate('Paid by Other Methods')}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.specificProductsOther.ht)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.specificProductsOther.tva)}</td>
                                                                    <td className="px-4 py-3 text-right text-sm">{formatCurrency(summary.specificProductsOther.ttc)}</td>
                                                                </tr>
                                                            </>
                                                        ) : (
                                                            <tr className="bg-cyan-50 hover:bg-cyan-100">
                                                                <td className="px-4 py-3 text-cyan-800">🛍️ {specificProductCategoryName}</td>
                                                                <td className="px-4 py-3 text-right">{formatCurrency(summary.specificProducts.ht)}</td>
                                                                <td className="px-4 py-3 text-right">{formatCurrency(summary.specificProducts.tva)}</td>
                                                                <td className="px-4 py-3 text-right font-semibold">{formatCurrency(summary.specificProducts.ttc)}</td>
                                                            </tr>
                                                        )}
                                                    </>
                                                )}
                                                
                                                {summary.giftVouchers.ttc > 0 && (
                                                    <tr className="bg-purple-50 hover:bg-purple-100">
                                                        <td className="px-4 py-3 text-purple-800">🎁 {translate('Gift Vouchers')}</td>
                                                        <td className="px-4 py-3 text-right">{formatCurrency(summary.giftVouchers.ht)}</td>
                                                        <td className="px-4 py-3 text-right">{formatCurrency(summary.giftVouchers.tva)}</td>
                                                        <td className="px-4 py-3 text-right font-semibold">{formatCurrency(summary.giftVouchers.ttc)}</td>
                                                    </tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                {data.length > 0 && paymentMethods && (
                                    <div className="bg-white rounded-lg shadow-lg p-6 mb-6 print-section">
                                        <h2 className="text-2xl font-bold text-gray-800 mb-4">💳 {exportLanguage === 'fr' ? 'Répartition par Moyen de Paiement' : 'Payment Methods Breakdown'}</h2>
                                        
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead className="bg-purple-600 text-white">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left">{exportLanguage === 'fr' ? 'Moyen de Paiement' : 'Payment Method'}</th>
                                                        <th className="px-4 py-3 text-right">{exportLanguage === 'fr' ? 'Montant' : 'Amount'}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr className="bg-purple-50 border-b-2 border-purple-600">
                                                        <td className="px-4 py-3 font-bold text-purple-900">{translate('Total Collected')}</td>
                                                        <td className="px-4 py-3 text-right font-bold text-purple-900">{formatCurrency(paymentMethods.total)}</td>
                                                    </tr>
                                                    
                                                    {paymentMethods.cash > 0 && (
                                                        <tr className="bg-gray-50 hover:bg-gray-100">
                                                            <td className="px-4 py-3 text-gray-800">💵 {translate('Cash')}</td>
                                                            <td className="px-4 py-3 text-right font-semibold">{formatCurrency(paymentMethods.cash)}</td>
                                                        </tr>
                                                    )}
                                                    
                                                    {paymentMethods.instore_card > 0 && (
                                                        <tr className="bg-gray-50 hover:bg-gray-100">
                                                            <td className="px-4 py-3 text-gray-800">💳 {translate('Card (In-Store)')}</td>
                                                            <td className="px-4 py-3 text-right font-semibold">{formatCurrency(paymentMethods.instore_card)}</td>
                                                        </tr>
                                                    )}
                                                    
                                                    {paymentMethods.online_card > 0 && (
                                                        <tr className="bg-gray-50 hover:bg-gray-100">
                                                            <td className="px-4 py-3 text-gray-800">🌐 {translate('Card (Online)')}</td>
                                                            <td className="px-4 py-3 text-right font-semibold">{formatCurrency(paymentMethods.online_card)}</td>
                                                        </tr>
                                                    )}
                                                    
                                                    {paymentMethods.bank_transfer > 0 && (
                                                        <tr className="bg-gray-50 hover:bg-gray-100">
                                                            <td className="px-4 py-3 text-gray-800">🏦 {translate('Bank Transfer')}</td>
                                                            <td className="px-4 py-3 text-right font-semibold">{formatCurrency(paymentMethods.bank_transfer)}</td>
                                                        </tr>
                                                    )}
                                                    
                                                    {paymentMethods.cheque > 0 && (
                                                        <tr className="bg-gray-50 hover:bg-gray-100">
                                                            <td className="px-4 py-3 text-gray-800">📝 {translate('Check')}</td>
                                                            <td className="px-4 py-3 text-right font-semibold">{formatCurrency(paymentMethods.cheque)}</td>
                                                        </tr>
                                                    )}
                                                    
                                                    {paymentMethods.gift_voucher > 0 && (
                                                        <tr className="bg-purple-50 hover:bg-purple-100">
                                                            <td className="px-4 py-3 text-purple-800">🎁 {translate('Gift Voucher Used')}</td>
                                                            <td className="px-4 py-3 text-right font-semibold">{formatCurrency(paymentMethods.gift_voucher)}</td>
                                                        </tr>
                                                    )}
                                                    
                                                    {paymentMethods.other > 0 && (
                                                        <tr className="bg-gray-50 hover:bg-gray-100">
                                                            <td className="px-4 py-3 text-gray-800">❓ {translate('Other')}</td>
                                                            <td className="px-4 py-3 text-right font-semibold">{formatCurrency(paymentMethods.other)}</td>
                                                        </tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                                {data.length > 0 && anomalies && anomalies.length > 0 && (
                                    <div className="bg-white rounded-lg shadow-lg p-6 mb-6 print-section">
                                        <h2 className="text-2xl font-bold text-gray-800 mb-4">⚠️ {exportLanguage === 'fr' ? 'Anomalies Détectées' : 'Anomalies Detected'}</h2>
                                        
                                        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                                            <p className="text-sm text-red-800">
                                                {exportLanguage === 'fr' 
                                                    ? '⚠️ Ces transactions montrent un service annulé (0€) mais un paiement a été encaissé. Vérifiez s\'il s\'agit de frais d\'annulation (TVA applicable) ou d\'un remboursement à effectuer.'
                                                    : '⚠️ These transactions show a cancelled service (0€) but a payment was collected. Check if these are cancellation fees (VAT applicable) or if a refund should be issued.'}
                                            </p>
                                        </div>
                                        
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead className="bg-red-600 text-white">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left">{exportLanguage === 'fr' ? 'ID' : 'ID'}</th>
                                                        <th className="px-4 py-3 text-left">{exportLanguage === 'fr' ? 'Date' : 'Date'}</th>
                                                        <th className="px-4 py-3 text-left">{exportLanguage === 'fr' ? 'Client' : 'Customer'}</th>
                                                        <th className="px-4 py-3 text-left">{exportLanguage === 'fr' ? 'Boutique' : 'Shop'}</th>
                                                        <th className="px-4 py-3 text-right">{exportLanguage === 'fr' ? 'Service' : 'Service'}</th>
                                                        <th className="px-4 py-3 text-right">{exportLanguage === 'fr' ? 'Encaissé' : 'Collected'}</th>
                                                        <th className="px-4 py-3 text-right">{exportLanguage === 'fr' ? 'TVA Calculée' : 'VAT Calculated'}</th>
                                                        <th className="px-4 py-3 text-left">{exportLanguage === 'fr' ? 'Action Recommandée' : 'Recommended Action'}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {anomalies.map((anomaly, idx) => (
                                                        <tr key={idx} className={`border-b ${idx % 2 === 0 ? 'bg-red-50' : 'bg-white'} hover:bg-red-100`}>
                                                            <td className="px-4 py-3 text-sm">{anomaly.paymentId}</td>
                                                            <td className="px-4 py-3 text-sm">{anomaly.date}</td>
                                                            <td className="px-4 py-3 text-sm">{anomaly.customer}</td>
                                                            <td className="px-4 py-3 text-sm">{anomaly.shop}</td>
                                                            <td className="px-4 py-3 text-sm text-right">{formatCurrency(anomaly.totalServices)}</td>
                                                            <td className="px-4 py-3 text-sm text-right font-bold text-red-600">{formatCurrency(anomaly.totalPaid)}</td>
                                                            <td className="px-4 py-3 text-sm text-right font-bold text-red-600">
                                                                {formatCurrency(anomaly.vatAmount)} ({anomaly.vatRate}%)
                                                            </td>
                                                            <td className="px-4 py-3 text-sm text-red-700">
                                                                {exportLanguage === 'fr' 
                                                                    ? 'Vérifier : Frais d\'annulation ou Remboursement à faire'
                                                                    : 'Check: Cancellation fees or Refund needed'}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                {data.length > 0 && pendingPayments && pendingPayments.length > 0 && (
                                    <div className="bg-white rounded-lg shadow-lg p-6 mb-6 print-section">
                                        <h2 className="text-2xl font-bold text-gray-800 mb-4">⏳ {exportLanguage === 'fr' ? 'Paiements en Attente' : 'Pending Payments'}</h2>
                                        
                                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                                            <p className="text-sm text-yellow-800">
                                                {exportLanguage === 'fr' 
                                                    ? '⚠️ Ces transactions ont des paiements incomplets ou aucun paiement enregistré. Vérifiez votre régime de TVA pour savoir si vous devez ajuster vos déclarations.'
                                                    : '⚠️ These transactions have incomplete or no recorded payments. Check your VAT regime to determine if you need to adjust your declarations.'}
                                            </p>
                                        </div>
                                        
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead className="bg-orange-600 text-white">
                                                    <tr>
                                                        <th className="px-4 py-3 text-left">{exportLanguage === 'fr' ? 'ID' : 'ID'}</th>
                                                        <th className="px-4 py-3 text-left">{exportLanguage === 'fr' ? 'Date' : 'Date'}</th>
                                                        <th className="px-4 py-3 text-left">{exportLanguage === 'fr' ? 'Client' : 'Customer'}</th>
                                                        <th className="px-4 py-3 text-left">{exportLanguage === 'fr' ? 'Boutique' : 'Shop'}</th>
                                                        <th className="px-4 py-3 text-right">{exportLanguage === 'fr' ? 'Total Dû' : 'Total Due'}</th>
                                                        <th className="px-4 py-3 text-right">{exportLanguage === 'fr' ? 'Payé' : 'Paid'}</th>
                                                        <th className="px-4 py-3 text-right">{exportLanguage === 'fr' ? 'Reste à Payer' : 'Amount Pending'}</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {pendingPayments.map((payment, idx) => (
                                                        <tr key={idx} className={`border-b ${idx % 2 === 0 ? 'bg-orange-50' : 'bg-white'} hover:bg-orange-100`}>
                                                            <td className="px-4 py-3 text-sm">{payment.paymentId}</td>
                                                            <td className="px-4 py-3 text-sm">{payment.date}</td>
                                                            <td className="px-4 py-3 text-sm">{payment.customer}</td>
                                                            <td className="px-4 py-3 text-sm">{payment.shop}</td>
                                                            <td className="px-4 py-3 text-sm text-right">{formatCurrency(payment.totalDue)}</td>
                                                            <td className="px-4 py-3 text-sm text-right">{formatCurrency(payment.totalPaid)}</td>
                                                            <td className="px-4 py-3 text-sm text-right font-bold text-orange-600">{formatCurrency(payment.amountPending)}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}

                                <div className="bg-white rounded-lg shadow-lg overflow-hidden print-section">
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead className="bg-indigo-600 text-white">
                                                <tr>
                                                    {getTableHeaders().map((header, idx) => (
                                                        <th key={idx} className={`px-4 py-3 text-sm ${idx >= 4 ? 'text-right' : 'text-left'} ${idx === 5 || idx === 6 ? 'text-center' : ''}`}>
                                                            {header}
                                                        </th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {data.map((row, i) => (
                                                    <tr key={i} className={`border-b ${i % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-indigo-50`}>
                                                        <td className="px-4 py-3 text-sm">{row.payment}</td>
                                                        <td className="px-4 py-3 text-sm">{row['Heure et jour'] || row['datetime'] || row['Date and time'] || row['date_and_time'] || '-'}</td>
                                                        <td className="px-4 py-3 text-sm">
                                                            <span className={`px-2 py-1 rounded text-xs ${row.transaction === 'appointment' ? 'bg-green-100 text-green-800' : row.transaction === 'product_sale' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`}>
                                                                {row.transaction}
                                                            </span>
                                                        </td>
                                                        <td className="px-4 py-3 text-sm">{row.type}</td>
                                                        <td className="px-4 py-3 text-sm text-right font-medium">{formatCurrency(row.gross_value)}</td>
                                                        <td className="px-4 py-3 text-sm text-center">
                                                            {row.vat_category && (
                                                                <span className={`px-2 py-1 rounded text-xs font-semibold ${
                                                                    row.vat_category === 'Appointment' || row.vat_category === 'Package' ? 'bg-green-100 text-green-800' : 
                                                                    row.vat_category === 'Product' ? 'bg-blue-100 text-blue-800' : 
                                                                    row.vat_category === specificProductCategoryName ? 'bg-cyan-100 text-cyan-800' : 
                                                                    'bg-purple-100 text-purple-800'
                                                                }`}>
                                                                    {translateCategory(row.vat_category)}
                                                                </span>
                                                            )}
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-center">
                                                            {row.vat_rate !== '' && <span className="px-2 py-1 rounded text-xs font-semibold bg-indigo-100 text-indigo-800">{row.vat_rate}%</span>}
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-right font-bold text-indigo-600">{row.vat_amount ? formatCurrency(row.vat_amount) : '-'}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<VATCalculator />, document.getElementById('root'));
    </script>
</body>
</html>
