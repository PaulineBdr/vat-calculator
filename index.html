<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAT Calculator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;

        function VATCalculator() {
          const [data, setData] = useState([]);
          const [fileName, setFileName] = useState('');
          const [error, setError] = useState('');
          const [vatRateAppointment, setVatRateAppointment] = useState(20);
          const [vatRateProduct, setVatRateProduct] = useState(20);
          const [vatRateGiftVoucher, setVatRateGiftVoucher] = useState(0);
          
          const [enableSpecificProductRate, setEnableSpecificProductRate] = useState(false);
          const [vatRateProductSpecific, setVatRateProductSpecific] = useState(5.5);
          const [specificProductCategoryName, setSpecificProductCategoryName] = useState('Product (Specific)');
          const [specificProductKeywords, setSpecificProductKeywords] = useState('');
          
          const [packageKeywords, setPackageKeywords] = useState('s√©ances,s√©ance,forfait,package,abonnement,subscription,sessions,session');
          const [giftVoucherKeywords, setGiftVoucherKeywords] = useState('bon cadeau,ch√®que cadeau,carte cadeau,gift card,gift voucher,voucher,gift certificate,massage,soin,spa,coupe,cut,coloration,color,balayage,m√®ches,highlights,brushing,manucure,manicure,p√©dicure,pedicure,facial,√©pilation,waxing,maquillage,makeup,soins du visage,skincare');
          const [showKeywords, setShowKeywords] = useState(false);

          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            setFileName(file.name);
            setError('');

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const parsedData = [];
                const paymentGroups = {};
                
                for (let i = 1; i < lines.length; i++) {
                  if (!lines[i].trim()) continue;
                  
                  const values = [];
                  let current = '';
                  let inQuotes = false;
                  
                  for (let char of lines[i]) {
                    if (char === '"') {
                      inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                      values.push(current.trim());
                      current = '';
                    } else {
                      current += char;
                    }
                  }
                  values.push(current.trim());
                  
                  const row = {};
                  headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                  });
                  
                  const paymentId = row.payment;
                  if (!paymentGroups[paymentId]) {
                    paymentGroups[paymentId] = [];
                  }
                  paymentGroups[paymentId].push(row);
                }
                
                const packageKw = packageKeywords.toLowerCase().split(',').map(k => k.trim());
                const giftKw = giftVoucherKeywords.toLowerCase().split(',').map(k => k.trim());
                const specificProdKw = enableSpecificProductRate ? specificProductKeywords.toLowerCase().split(',').map(k => k.trim()) : [];
                
                for (const paymentId in paymentGroups) {
                  const group = paymentGroups[paymentId];
                  
                  const hasPayment = group.some(row => {
                    const transaction = row.transaction?.toLowerCase() || '';
                    const grossValue = parseFloat(row.gross_value) || 0;
                    return grossValue < 0 || 
                           transaction.includes('carte') || 
                           transaction.includes('esp√®ces') ||
                           transaction.includes('especes') ||
                           transaction.includes('virement') ||
                           transaction.includes('cash') ||
                           transaction.includes('card');
                  });
                  
                  group.forEach(row => {
                    const transaction = row.transaction?.toLowerCase() || '';
                    const type = row.type?.toLowerCase() || '';
                    const grossValue = parseFloat(row.gross_value) || 0;
                    
                    if (hasPayment && grossValue > 0) {
                      if (transaction === 'appointment') {
                        row.vat_amount = (grossValue * (vatRateAppointment / 100)).toFixed(2);
                        row.vat_rate = vatRateAppointment;
                        row.vat_category = 'Appointment';
                      } else if (transaction === 'product_sale') {
                        const isPackage = packageKw.some(keyword => type.includes(keyword));
                        
                        if (isPackage) {
                          row.vat_amount = (grossValue * (vatRateAppointment / 100)).toFixed(2);
                          row.vat_rate = vatRateAppointment;
                          row.vat_category = 'Package';
                        } else {
                          const isGiftVoucher = giftKw.some(keyword => type.includes(keyword));
                          
                          if (isGiftVoucher) {
                            row.vat_amount = (grossValue * (vatRateGiftVoucher / 100)).toFixed(2);
                            row.vat_rate = vatRateGiftVoucher;
                            row.vat_category = 'Gift Voucher';
                          } else {
                            const isSpecificProduct = enableSpecificProductRate && specificProdKw.some(keyword => type.includes(keyword));
                            
                            if (isSpecificProduct) {
                              row.vat_amount = (grossValue * (vatRateProductSpecific / 100)).toFixed(2);
                              row.vat_rate = vatRateProductSpecific;
                              row.vat_category = specificProductCategoryName;
                            } else {
                              row.vat_amount = (grossValue * (vatRateProduct / 100)).toFixed(2);
                              row.vat_rate = vatRateProduct;
                              row.vat_category = 'Product';
                            }
                          }
                        }
                      } else {
                        row.vat_amount = '';
                        row.vat_rate = '';
                        row.vat_category = '';
                      }
                    } else {
                      row.vat_amount = '';
                      row.vat_rate = '';
                      row.vat_category = '';
                    }
                    
                    parsedData.push(row);
                  });
                }
                
                setData(parsedData);
              } catch (err) {
                setError('Error reading file: ' + err.message);
              }
            };
            
            reader.readAsText(file);
          };

          const downloadCSV = () => {
            if (data.length === 0) return;
            
            const headers = ['payment', 'Heure et jour', 'transaction', 'type', 'gross_value', 
                             'VAT Rate', 'VAT Amount', 'VAT Category', 'shop', 'employee', 'customer_name', 'additional_info',
                             'bank_account', 'online_payment_arrival', 'online_payment_fee', 'url'];
            
            let csv = headers.join(',') + '\n';
            
            data.forEach(row => {
              const escapeCSV = (str) => {
                if (!str) return '';
                const stringValue = String(str);
                if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                  return '"' + stringValue.replace(/"/g, '""') + '"';
                }
                return stringValue;
              };
              
              const values = [
                escapeCSV(row.payment),
                escapeCSV(row['Heure et jour']),
                escapeCSV(row.transaction),
                escapeCSV(row.type),
                escapeCSV(row.gross_value),
                escapeCSV(row.vat_rate ? row.vat_rate + '%' : ''),
                escapeCSV(row.vat_amount),
                escapeCSV(row.vat_category),
                escapeCSV(row.shop),
                escapeCSV(row.employee),
                escapeCSV(row.customer_name),
                escapeCSV(row.additional_info),
                escapeCSV(row.bank_account),
                escapeCSV(row.online_payment_arrival),
                escapeCSV(row.online_payment_fee),
                escapeCSV(row.url)
              ];
              csv += values.join(',') + '\n';
            });
            
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            const newFileName = fileName.replace('.csv', '') + '_with_VAT.csv';
            link.download = newFileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          };

          const downloadExcel = () => {
            if (data.length === 0) return;

            const headers = ['payment', 'Heure et jour', 'transaction', 'type', 'gross_value', 
                           'VAT Rate', 'VAT Amount', 'VAT Category', 'shop', 'employee', 'customer_name', 
                           'additional_info', 'bank_account', 'online_payment_arrival', 'online_payment_fee', 'url'];
            
            const excelData = data.map(row => [
              row.payment,
              row['Heure et jour'],
              row.transaction,
              row.type,
              parseFloat(row.gross_value) || 0,
              row.vat_rate ? row.vat_rate + '%' : '',
              parseFloat(row.vat_amount) || '',
              row.vat_category || '',
              row.shop,
              row.employee,
              row.customer_name,
              row.additional_info,
              row.bank_account,
              row.online_payment_arrival,
              row.online_payment_fee,
              row.url
            ]);

            const ws = XLSX.utils.aoa_to_sheet([headers, ...excelData]);
            
            ws['!cols'] = [
              { wch: 10 }, { wch: 16 }, { wch: 14 }, { wch: 30 }, { wch: 12 },
              { wch: 10 }, { wch: 12 }, { wch: 18 }, { wch: 12 }, { wch: 15 },
              { wch: 20 }, { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 15 }, { wch: 50 }
            ];

            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
              const address = XLSX.utils.encode_col(C) + '1';
              if (!ws[address]) continue;
              ws[address].s = {
                font: { bold: true, color: { rgb: "FFFFFF" } },
                fill: { fgColor: { rgb: "4F46E5" } },
                alignment: { horizontal: "center", vertical: "center" }
              };
            }

            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
              const categoryCell = XLSX.utils.encode_cell({ r: R, c: 7 });
              if (ws[categoryCell] && ws[categoryCell].v) {
                const category = ws[categoryCell].v;
                let bgColor = "FFFFFF";
                
                if (category === 'Appointment' || category === 'Package') {
                  bgColor = "D1FAE5";
                } else if (category === 'Gift Voucher') {
                  bgColor = "FEF3C7";
                } else if (category === 'Product') {
                  bgColor = "DBEAFE";
                } else if (category === specificProductCategoryName) {
                  bgColor = "E0F2FE";
                }
                
                ws[categoryCell].s = {
                  fill: { fgColor: { rgb: bgColor } },
                  alignment: { horizontal: "center" }
                };
              }

              [4, 6].forEach(C => {
                const address = XLSX.utils.encode_cell({ r: R, c: C });
                if (!ws[address] || !ws[address].v) return;
                ws[address].z = '#,##0.00';
              });
            }

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'VAT Calculations');
            XLSX.writeFile(wb, fileName.replace('.csv', '') + '_with_VAT.xlsx');
          };

          const downloadPDF = () => {
            if (data.length === 0) return;

            const printWindow = window.open('', '', 'width=1200,height=800');
            
            const html = `
              <!DOCTYPE html>
              <html>
              <head>
                <title>VAT Calculations - ${fileName}</title>
                <style>
                  body { font-family: Arial, sans-serif; padding: 20px; margin: 0; font-size: 10px; }
                  h1 { color: #4F46E5; margin-bottom: 20px; font-size: 18px; }
                  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                  th {
                    background-color: #4F46E5; color: white; padding: 8px 4px;
                    text-align: left; font-weight: bold; border: 1px solid #4F46E5; font-size: 9px;
                  }
                  td { padding: 6px 4px; border: 1px solid #E5E7EB; font-size: 9px; }
                  tr:nth-child(even) { background-color: #F9FAFB; }
                  .category-appointment { background-color: #D1FAE5 !important; }
                  .category-gift { background-color: #FEF3C7 !important; }
                  .category-product { background-color: #DBEAFE !important; }
                  .category-specific { background-color: #E0F2FE !important; }
                  .text-right { text-align: right; }
                  .text-center { text-align: center; }
                  @media print {
                    body { padding: 10px; }
                    h1 { font-size: 16px; }
                  }
                </style>
              </head>
              <body>
                <h1>VAT Calculations - ${fileName}</h1>
                <table>
                  <thead>
                    <tr>
                      <th>ID</th><th>Date & Time</th><th>Transaction</th><th>Type</th>
                      <th class="text-right">Gross Value</th><th class="text-center">Category</th>
                      <th class="text-center">VAT Rate</th><th class="text-right">VAT Amount</th>
                      <th>Employee</th><th>Customer</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${data.map(row => {
                      let categoryClass = '';
                      if (row.vat_category === 'Appointment' || row.vat_category === 'Package') categoryClass = 'category-appointment';
                      else if (row.vat_category === 'Gift Voucher') categoryClass = 'category-gift';
                      else if (row.vat_category === 'Product') categoryClass = 'category-product';
                      else if (row.vat_category === specificProductCategoryName) categoryClass = 'category-specific';
                      
                      return `
                        <tr>
                          <td>${row.payment || ''}</td>
                          <td>${row['Heure et jour'] || ''}</td>
                          <td>${row.transaction || ''}</td>
                          <td>${row.type || ''}</td>
                          <td class="text-right">${row.gross_value ? parseFloat(row.gross_value).toFixed(2) + ' ‚Ç¨' : ''}</td>
                          <td class="text-center ${categoryClass}">${row.vat_category || ''}</td>
                          <td class="text-center">${row.vat_rate ? row.vat_rate + '%' : ''}</td>
                          <td class="text-right">${row.vat_amount ? parseFloat(row.vat_amount).toFixed(2) + ' ‚Ç¨' : ''}</td>
                          <td>${row.employee || ''}</td>
                          <td>${row.customer_name || ''}</td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
                <script>
                  window.onload = function() {
                    window.print();
                    setTimeout(function() { window.close(); }, 100);
                  }
                </script>
              </body>
              </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
          };

          const formatCurrency = (value) => {
            if (!value) return '-';
            const num = parseFloat(value);
            return num.toFixed(2) + ' ‚Ç¨';
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
              <div className="max-w-7xl mx-auto">
                <div className="bg-white rounded-lg shadow-lg p-8 mb-6">
                  <div className="flex items-center gap-3 mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-600">
                      <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                      <polyline points="14 2 14 8 20 8"/>
                    </svg>
                    <h1 className="text-3xl font-bold text-gray-800">VAT Calculator</h1>
                  </div>
                  
                  <p className="text-gray-600 mb-6">
                    Import your payment CSV file to automatically calculate VAT with different rates based on transaction type.
                    <strong> VAT is only calculated for transactions that have been paid.</strong>
                  </p>

                  <div className="mb-6 bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-lg font-semibold text-indigo-900">VAT Rates Configuration</h3>
                      <button
                        onClick={() => setShowKeywords(!showKeywords)}
                        className="text-sm text-indigo-600 hover:text-indigo-800 underline"
                      >
                        {showKeywords ? 'Hide' : 'Show'} Keywords Settings
                      </button>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="bg-white rounded-lg p-4 border border-indigo-200">
                        <label className="block text-sm font-semibold text-green-800 mb-3">
                          üìÖ Appointments & Packages
                        </label>
                        <div className="flex gap-2 mb-3">
                          <button onClick={() => setVatRateAppointment(5.5)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateAppointment === 5.5 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>5.5%</button>
                          <button onClick={() => setVatRateAppointment(10)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateAppointment === 10 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>10%</button>
                          <button onClick={() => setVatRateAppointment(20)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateAppointment === 20 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>20%</button>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-sm text-gray-700">Custom:</span>
                          <input type="number" min="0" max="100" step="0.1" value={vatRateAppointment} onChange={(e) => setVatRateAppointment(parseFloat(e.target.value) || 0)} className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-green-500"/>
                          <span className="text-sm text-gray-700">%</span>
                        </div>
                      </div>

                      <div className="bg-white rounded-lg p-4 border border-indigo-200">
                        <label className="block text-sm font-semibold text-blue-800 mb-3">
                          üõçÔ∏è Physical Products
                        </label>
                        
                        <div className="mb-3">
                          <p className="text-xs text-gray-700 mb-2 font-medium">Generic rate:</p>
                          <div className="flex gap-2 mb-2">
                            <button onClick={() => setVatRateProduct(5.5)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateProduct === 5.5 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>5.5%</button>
                            <button onClick={() => setVatRateProduct(10)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateProduct === 10 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>10%</button>
                            <button onClick={() => setVatRateProduct(20)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateProduct === 20 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>20%</button>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="text-sm text-gray-700">Custom:</span>
                            <input type="number" min="0" max="100" step="0.1" value={vatRateProduct} onChange={(e) => setVatRateProduct(parseFloat(e.target.value) || 0)} className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                            <span className="text-sm text-gray-700">%</span>
                          </div>
                        </div>

                        <div className="border-t border-gray-200 pt-3 mt-3">
                          <label className="flex items-center gap-2 mb-3 cursor-pointer">
                            <input
                              type="checkbox"
                              checked={enableSpecificProductRate}
                              onChange={(e) => setEnableSpecificProductRate(e.target.checked)}
                              className="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                            />
                            <span className="text-xs font-medium text-gray-700">Enable specific rate</span>
                          </label>

                          {enableSpecificProductRate && (
                            <div className="ml-6 space-y-3">
                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Category name:</label>
                                <input
                                  type="text"
                                  value={specificProductCategoryName}
                                  onChange={(e) => setSpecificProductCategoryName(e.target.value)}
                                  className="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="e.g., Dietary Supplement, Food..."
                                />
                              </div>

                              <div>
                                <p className="text-xs text-gray-700 mb-2 font-medium">Specific rate:</p>
                                <div className="flex gap-2 mb-2">
                                  <button onClick={() => setVatRateProductSpecific(0)} className={`px-2 py-1 rounded text-xs font-medium transition-colors ${vatRateProductSpecific === 0 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>0%</button>
                                  <button onClick={() => setVatRateProductSpecific(5.5)} className={`px-2 py-1 rounded text-xs font-medium transition-colors ${vatRateProductSpecific === 5.5 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>5.5%</button>
                                  <button onClick={() => setVatRateProductSpecific(10)} className={`px-2 py-1 rounded text-xs font-medium transition-colors ${vatRateProductSpecific === 10 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>10%</button>
                                  <button onClick={() => setVatRateProductSpecific(20)} className={`px-2 py-1 rounded text-xs font-medium transition-colors ${vatRateProductSpecific === 20 ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>20%</button>
                                </div>
                                <div className="flex items-center gap-2">
                                  <span className="text-xs text-gray-700">Custom:</span>
                                  <input type="number" min="0" max="100" step="0.1" value={vatRateProductSpecific} onChange={(e) => setVatRateProductSpecific(parseFloat(e.target.value) || 0)} className="w-16 px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                                  <span className="text-xs text-gray-700">%</span>
                                </div>
                              </div>

                              <div>
                                <label className="block text-xs font-medium text-gray-700 mb-1">Product names:</label>
                                <textarea
                                  value={specificProductKeywords}
                                  onChange={(e) => setSpecificProductKeywords(e.target.value)}
                                  rows="2"
                                  className="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Enter exact product names separated by commas. Example: Omega 3 Capsules, Vitamin D3 1000 IU, Collagen Powder"
                                />
                                <p className="text-xs text-gray-500 mt-1">List the exact product names (as they appear in your file) that should use the specific rate</p>
                              </div>
                            </div>
                          )}
                        </div>
                      </div>

                      <div className="bg-white rounded-lg p-4 border border-indigo-200">
                        <label className="block text-sm font-semibold text-purple-800 mb-3">
                          üéÅ Gift Vouchers
                        </label>
                        <div className="bg-yellow-50 border border-yellow-200 rounded p-2 mb-3">
                          <p className="text-xs text-yellow-800">
                            <strong>‚ö†Ô∏è Important:</strong> Check with the client when VAT should be declared:
                            <br/>‚Ä¢ <strong>At voucher purchase</strong> ‚Üí Set appropriate rate
                            <br/>‚Ä¢ <strong>At voucher use</strong> ‚Üí Keep at 0% (VAT will be declared when used)
                          </p>
                        </div>
                        <div className="flex gap-2 mb-3">
                          <button onClick={() => setVatRateGiftVoucher(0)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateGiftVoucher === 0 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>0%</button>
                          <button onClick={() => setVatRateGiftVoucher(5.5)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateGiftVoucher === 5.5 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>5.5%</button>
                          <button onClick={() => setVatRateGiftVoucher(10)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateGiftVoucher === 10 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>10%</button>
                          <button onClick={() => setVatRateGiftVoucher(20)} className={`px-3 py-2 rounded-lg text-sm font-medium transition-colors ${vatRateGiftVoucher === 20 ? 'bg-purple-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}>20%</button>
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-sm text-gray-700">Custom:</span>
                          <input type="number" min="0" max="100" step="0.1" value={vatRateGiftVoucher} onChange={(e) => setVatRateGiftVoucher(parseFloat(e.target.value) || 0)} className="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-purple-500"/>
                          <span className="text-sm text-gray-700">%</span>
                        </div>
                      </div>
                    </div>

                    {showKeywords && (
                      <div className="mt-4 pt-4 border-t border-indigo-200">
                        <h4 className="text-sm font-semibold text-indigo-900 mb-3">Keywords Detection Settings</h4>
                        <div className="space-y-3">
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">Package Keywords (comma-separated)</label>
                            <input
                              type="text"
                              value={packageKeywords}
                              onChange={(e) => setPackageKeywords(e.target.value)}
                              className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                            <p className="text-xs text-gray-500 mt-1">Product sales containing these keywords will be treated as packages</p>
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-1">Gift Voucher Keywords (comma-separated)</label>
                            <input
                              type="text"
                              value={giftVoucherKeywords}
                              onChange={(e) => setGiftVoucherKeywords(e.target.value)}
                              className="w-full px-3 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            />
                            <p className="text-xs text-gray-500 mt-1">Product sales containing these keywords will be treated as gift vouchers (0% VAT)</p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  <div className="flex gap-4 mb-6">
                    <label className="flex-1 cursor-pointer">
                      <div className="flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                          <polyline points="17 8 12 3 7 8"/>
                          <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <span>Load CSV File</span>
                      </div>
                      <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden"/>
                    </label>

                    {data.length > 0 && (
                      <>
                        <button onClick={downloadCSV} className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition-colors">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                          </svg>
                          <span>Download CSV</span>
                        </button>

                        <button onClick={downloadExcel} className="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg transition-colors">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                          </svg>
                          <span>Download Excel</span>
                        </button>

                        <button onClick={downloadPDF} className="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition-colors">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                          </svg>
                          <span>Download PDF</span>
                        </button>
                      </>
                    )}
                  </div>

                  {fileName && (
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                      <p className="text-blue-800"><strong>File loaded:</strong> {fileName} {data.length > 0 && `(${data.length} rows)`}</p>
                    </div>
                  )}

                  {error && (
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                      <p className="text-red-800">{error}</p>
                    </div>
                  )}
                </div>

                {data.length > 0 && (
                  <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-indigo-600 text-white">
                          <tr>
                            <th className="px-4 py-3 text-left text-sm font-semibold">ID</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Date & Time</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Transaction</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Type</th>
                            <th className="px-4 py-3 text-right text-sm font-semibold">Gross Value</th>
                            <th className="px-4 py-3 text-center text-sm font-semibold">Category</th>
                            <th className="px-4 py-3 text-center text-sm font-semibold">VAT Rate</th>
                            <th className="px-4 py-3 text-right text-sm font-semibold">VAT Amount</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Employee</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">Customer</th>
                            <th className="px-4 py-3 text-left text-sm font-semibold">URL</th>
                          </tr>
                        </thead>
                        <tbody>
                          {data.map((row, index) => (
                            <tr key={index} className={`border-b ${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-indigo-50`}>
                              <td className="px-4 py-3 text-sm">{row.payment}</td>
                              <td className="px-4 py-3 text-sm">{row['Heure et jour']}</td>
                              <td className="px-4 py-3 text-sm">
                                <span className={`px-2 py-1 rounded text-xs ${row.transaction === 'appointment' ? 'bg-green-100 text-green-800' : row.transaction === 'product_sale' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}`}>
                                  {row.transaction}
                                </span>
                              </td>
                              <td className="px-4 py-3 text-sm">{row.type}</td>
                              <td className="px-4 py-3 text-sm text-right font-medium">{formatCurrency(row.gross_value)}</td>
                              <td className="px-4 py-3 text-sm text-center">
                                {row.vat_category && (
                                  <span className={`px-2 py-1 rounded text-xs font-semibold ${row.vat_category === 'Appointment' || row.vat_category === 'Package' ? 'bg-green-100 text-green-800' : row.vat_category === 'Product' ? 'bg-blue-100 text-blue-800' : row.vat_category === specificProductCategoryName ? 'bg-cyan-100 text-cyan-800' : 'bg-purple-100 text-purple-800'}`}>
                                    {row.vat_category}
                                  </span>
                                )}
                              </td>
                              <td className="px-4 py-3 text-sm text-center">
                                {row.vat_rate !== '' && <span className="px-2 py-1 rounded text-xs font-semibold bg-indigo-100 text-indigo-800">{row.vat_rate}%</span>}
                              </td>
                              <td className="px-4 py-3 text-sm text-right font-bold text-indigo-600">{row.vat_amount ? formatCurrency(row.vat_amount) : '-'}</td>
                              <td className="px-4 py-3 text-sm">{row.employee}</td>
                              <td className="px-4 py-3 text-sm">{row.customer_name}</td>
                              <td className="px-4 py-3 text-sm">
                                {row.url && <a href={row.url} target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:text-indigo-800 underline text-xs">Link</a>}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<VATCalculator />);
    </script>
</body>
</html>
