<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAT Calculator</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState } = React;
        const { Upload, Download, FileText } = lucide;

        function VATCalculator() {
          const [data, setData] = useState([]);
          const [fileName, setFileName] = useState('');
          const [error, setError] = useState('');
          const [vatRateAppointment, setVatRateAppointment] = useState(20);
          const [vatRateProduct, setVatRateProduct] = useState(10);
          const [vatRateGiftVoucher, setVatRateGiftVoucher] = useState(0);
          
          // Keywords for detection
          const [packageKeywords, setPackageKeywords] = useState('séances,séance,forfait,package,abonnement,subscription,sessions,session');
          const [giftVoucherKeywords, setGiftVoucherKeywords] = useState('bon cadeau,chèque cadeau,carte cadeau,gift card,gift voucher,voucher,gift certificate,massage,soin,spa,coupe,cut,coloration,color,balayage,mèches,highlights,brushing,manucure,manicure,pédicure,pedicure,facial,épilation,waxing,maquillage,makeup,soins du visage,skincare');
          const [showKeywords, setShowKeywords] = useState(false);

          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            setFileName(file.name);
            setError('');

            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const text = e.target.result;
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const parsedData = [];
                const paymentGroups = {};
                
                // First pass: group lines by payment ID
                for (let i = 1; i < lines.length; i++) {
                  if (!lines[i].trim()) continue;
                  
                  const values = [];
                  let current = '';
                  let inQuotes = false;
                  
                  for (let char of lines[i]) {
                    if (char === '"') {
                      inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                      values.push(current.trim());
                      current = '';
                    } else {
                      current += char;
                    }
                  }
                  values.push(current.trim());
                  
                  const row = {};
                  headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                  });
                  
                  const paymentId = row.payment;
                  if (!paymentGroups[paymentId]) {
                    paymentGroups[paymentId] = [];
                  }
                  paymentGroups[paymentId].push(row);
                }
                
                // Second pass: calculate VAT based on payment status
                const packageKw = packageKeywords.toLowerCase().split(',').map(k => k.trim());
                const giftKw = giftVoucherKeywords.toLowerCase().split(',').map(k => k.trim());
                
                for (const paymentId in paymentGroups) {
                  const group = paymentGroups[paymentId];
                  
                  // Check if there's a payment line (negative gross_value or payment transaction)
                  const hasPayment = group.some(row => {
                    const transaction = row.transaction?.toLowerCase() || '';
                    const grossValue = parseFloat(row.gross_value) || 0;
                    return grossValue < 0 || 
                           transaction.includes('carte') || 
                           transaction.includes('espèces') ||
                           transaction.includes('especes') ||
                           transaction.includes('virement') ||
                           transaction.includes('cash') ||
                           transaction.includes('card');
                  });
                  
                  // Process each row in the group
                  group.forEach(row => {
                    const transaction = row.transaction?.toLowerCase() || '';
                    const type = row.type?.toLowerCase() || '';
                    const grossValue = parseFloat(row.gross_value) || 0;
                    
                    // Only calculate VAT if there's a payment AND it's appointment or product_sale
                    if (hasPayment && grossValue > 0) {
                      if (transaction === 'appointment') {
                        row.vat_amount = (grossValue * (vatRateAppointment / 100)).toFixed(2);
                        row.vat_rate = vatRateAppointment;
                        row.vat_category = 'Appointment';
                      } else if (transaction === 'product_sale') {
                        // Check for package keywords
                        const isPackage = packageKw.some(keyword => type.includes(keyword));
                        
                        if (isPackage) {
                          // Package = treat as appointment
                          row.vat_amount = (grossValue * (vatRateAppointment / 100)).toFixed(2);
                          row.vat_rate = vatRateAppointment;
                          row.vat_category = 'Package';
                        } else {
                          // Check for gift voucher keywords
                          const isGiftVoucher = giftKw.some(keyword => type.includes(keyword));
                          
                          if (isGiftVoucher) {
                            // Gift voucher = 0% VAT
                            row.vat_amount = (grossValue * (vatRateGiftVoucher / 100)).toFixed(2);
                            row.vat_rate = vatRateGiftVoucher;
                            row.vat_category = 'Gift Voucher';
                          } else {
                            // Physical product
                            row.vat_amount = (grossValue * (vatRateProduct / 100)).toFixed(2);
                            row.vat_rate = vatRateProduct;
                            row.vat_category = 'Product';
                          }
                        }
                      } else {
                        row.vat_amount = '';
                        row.vat_rate = '';
                        row.vat_category = '';
                      }
                    } else {
                      row.vat_amount = '';
                      row.vat_rate = '';
                      row.vat_category = '';
                    }
                    
                    parsedData.push(row);
                  });
                }
